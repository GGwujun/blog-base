<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-base/umi.css" />
    <script>
      window.routerBase = "/blog-base";
    </script>
    <script>
      window.publicPath = window.resourceBaseUrl || "/blog-base/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>31 | 时代之风（下）：HTTP/2内核剖析 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/详解http/06.飞翔篇/02" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a aria-current="page" class="active" href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></span><span>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></span><span>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a aria-current="page" class="active" href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></li><li>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></li><li>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/详解http/01.开篇词">01.开篇词</a><ul><li><a href="/blog-base/详解http/01.开篇词/01"><span>开篇词｜To Be a HTTP Hero</span></a></li></ul></li><li><a href="/blog-base/详解http/02.破冰篇">02.破冰篇</a><ul><li><a href="/blog-base/详解http/02.破冰篇/01"><span>01 | 时势与英雄：HTTP的前世今生</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/02"><span>02 | HTTP是什么？HTTP又不是什么？</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/03"><span>03 | HTTP世界全览（上）：与HTTP相关的各种概念</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/04"><span>04 | HTTP世界全览（下）：与HTTP相关的各种协议</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/05"><span>05 | 常说的“四层”和“七层”到底是什么？“五层”“六层”哪去了？</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/06"><span>06 | 域名里有哪些门道？</span></a></li><li><a href="/blog-base/详解http/02.破冰篇/07"><span>07 | 自己动手，搭建HTTP实验环境</span></a></li></ul></li><li><a href="/blog-base/详解http/03.基础篇">03.基础篇</a><ul><li><a href="/blog-base/详解http/03.基础篇/01"><span>08 | 键入网址再按下回车，后面究竟发生了什么？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/02"><span>09 | HTTP报文是什么样子的？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/03"><span>10 | 应该如何理解请求方法？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/04"><span>11 | 你能写出正确的网址吗？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/05"><span>12 | 响应状态码该怎么用？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/06"><span>13 | HTTP有哪些特点？</span></a></li><li><a href="/blog-base/详解http/03.基础篇/07"><span>14 | HTTP有哪些优点？又有哪些缺点？</span></a></li></ul></li><li><a href="/blog-base/详解http/04.进阶篇">04.进阶篇</a><ul><li><a href="/blog-base/详解http/04.进阶篇/01"><span>15 | 海纳百川：HTTP的实体数据</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/02"><span>16 | 把大象装进冰箱：HTTP传输大文件的方法</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/03"><span>17 | 排队也要讲效率：HTTP的连接管理</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/04"><span>18 | 四通八达：HTTP的重定向和跳转</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/05"><span>19 | 让我知道你是谁：HTTP的Cookie机制</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/06"><span>20 | 生鲜速递：HTTP的缓存控制</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/07"><span>21 | 良心中间商：HTTP的代理服务</span></a></li><li><a href="/blog-base/详解http/04.进阶篇/08"><span>22 | 冷链周转：HTTP的缓存代理</span></a></li></ul></li><li><a href="/blog-base/详解http/05.安全篇">05.安全篇</a><ul><li><a href="/blog-base/详解http/05.安全篇/01"><span>23 | HTTPS是什么？SSL/TLS又是什么？</span></a></li><li><a href="/blog-base/详解http/05.安全篇/02"><span>24 | 固若金汤的根本（上）：对称加密与非对称加密</span></a></li><li><a href="/blog-base/详解http/05.安全篇/03"><span>25 | 固若金汤的根本（下）：数字签名与证书</span></a></li><li><a href="/blog-base/详解http/05.安全篇/04"><span>26 | 信任始于握手：TLS1.2连接过程解析</span></a></li><li><a href="/blog-base/详解http/05.安全篇/05"><span>27 | 更好更快的握手：TLS1.3特性解析</span></a></li><li><a href="/blog-base/详解http/05.安全篇/06"><span>28 | 连接太慢该怎么办：HTTPS的优化</span></a></li><li><a href="/blog-base/详解http/05.安全篇/07"><span>29 | 我应该迁移到HTTPS吗？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-base/详解http/06.飞翔篇">06.飞翔篇</a><ul><li><a href="/blog-base/详解http/06.飞翔篇/01"><span>30 | 时代之风（上）：HTTP/2特性概览</span></a></li><li><a aria-current="page" class="active" href="/blog-base/详解http/06.飞翔篇/02"><span>31 | 时代之风（下）：HTTP/2内核剖析</span></a></li><li><a href="/blog-base/详解http/06.飞翔篇/03"><span>32 | 未来之路：HTTP/3展望</span></a></li><li><a href="/blog-base/详解http/06.飞翔篇/04"><span>33 | 我应该迁移到HTTP/2吗？</span></a></li></ul></li><li><a href="/blog-base/详解http/07.探索篇">07.探索篇</a><ul><li><a href="/blog-base/详解http/07.探索篇/01"><span>34 | Nginx：高性能的Web服务器</span></a></li><li><a href="/blog-base/详解http/07.探索篇/02"><span>35 | OpenResty：更灵活的Web服务器</span></a></li><li><a href="/blog-base/详解http/07.探索篇/03"><span>36 | WAF：保护我们的网络服务</span></a></li><li><a href="/blog-base/详解http/07.探索篇/04"><span>37 | CDN：加速我们的网络服务</span></a></li><li><a href="/blog-base/详解http/07.探索篇/05"><span>38 | WebSocket：沙盒里的TCP</span></a></li></ul></li><li><a href="/blog-base/详解http/08.总结篇">08.总结篇</a><ul><li><a href="/blog-base/详解http/08.总结篇/01"><span>39 | HTTP性能优化面面观（上）</span></a></li><li><a href="/blog-base/详解http/08.总结篇/02"><span>40 | HTTP性能优化面面观（下）</span></a></li></ul></li><li><a href="/blog-base/详解http/09.答疑篇">09.答疑篇</a><ul><li><a href="/blog-base/详解http/09.答疑篇/01"><span>41 | Linux/Mac实验环境搭建与URI查询参数</span></a></li><li><a href="/blog-base/详解http/09.答疑篇/02"><span>42 | DHE/ECDHE算法的原理</span></a></li><li><a href="/blog-base/详解http/09.答疑篇/03"><span>43 | 如何进行Docker实验环境搭建？</span></a></li></ul></li><li><a href="/blog-base/详解http/10.特别放送">10.特别放送</a><ul><li><a href="/blog-base/详解http/10.特别放送/01"><span>44 | 先睹为快：HTTP/3实验版本长什么样子？</span></a></li></ul></li><li><a href="/blog-base/详解http/11.结束语">11.结束语</a><ul><li><a href="/blog-base/详解http/11.结束语/01"><span>结束语 | 做兴趣使然的Hero</span></a></li><li><a href="/blog-base/详解http/11.结束语/02"><span>结课测试 | 这些HTTP协议知识，你真的掌握了吗？</span></a></li></ul></li><li><a href="/blog-base/详解http/summary">详解http</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="连接前言" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#连接前言"><span>连接前言</span></a></li><li title="头部压缩" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#头部压缩"><span>头部压缩</span></a></li><li title="二进制帧" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#二进制帧"><span>二进制帧</span></a></li><li title="流与多路复用" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#流与多路复用"><span>流与多路复用</span></a></li><li title="流状态转换" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#流状态转换"><span>流状态转换</span></a></li><li title="小结" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#小结"><span>小结</span></a></li><li title="课下作业" data-depth="2"><a href="/blog-base/详解http/06.飞翔篇/02#课下作业"><span>课下作业</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="31--时代之风下http2内核剖析"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#31--时代之风下http2内核剖析"><span class="icon icon-link"></span></a>31 | 时代之风（下）：HTTP/2内核剖析</h1><p>今天我们继续上一讲的话题，深入HTTP/2协议的内部，看看它的实现细节。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage89178903a45c632b64c220299d5bc64ef717.016606ca.png" alt=""/></p><p>这次实验环境的URI是“/31-1”，我用Wireshark把请求响应的过程抓包存了下来，文件放在GitHub的“wireshark”目录。今天我们就对照着抓包来实地讲解HTTP/2的头部压缩、二进制帧等特性。</p><h2 id="连接前言"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#连接前言"><span class="icon icon-link"></span></a>连接前言</h2><p>由于HTTP/2“事实上”是基于TLS，所以在正式收发数据之前，会有TCP握手和TLS握手，这两个步骤相信你一定已经很熟悉了，所以这里就略过去不再细说。</p><p>TLS握手成功之后，客户端必须要发送一个“<strong>连接前言</strong>”（connection preface），用来确认建立HTTP/2连接。</p><p>这个“连接前言”是标准的HTTP/1请求报文，使用纯文本的ASCII码格式，请求方法是特别注册的一个关键字“PRI”，全文只有24个字节：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n</span></div></pre></div><p>在Wireshark里，HTTP/2的“连接前言”被称为“<strong>Magic</strong>”，意思就是“不可知的魔法”。</p><p>所以，就不要问“为什么会是这样”了，只要服务器收到这个“有魔力的字符串”，就知道客户端在TLS上想要的是HTTP/2协议，而不是其他别的协议，后面就会都使用HTTP/2的数据格式。</p><h2 id="头部压缩"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#头部压缩"><span class="icon icon-link"></span></a>头部压缩</h2><p>确立了连接之后，HTTP/2就开始准备请求报文。</p><p>因为语义上它与HTTP/1兼容，所以报文还是由“Header+Body”构成的，但在请求发送前，必须要用“<strong>HPACK</strong>”算法来压缩头部数据。</p><p>“HPACK”算法是专门为压缩HTTP头部定制的算法，与gzip、zlib等压缩算法不同，它是一个“有状态”的算法，需要客户端和服务器各自维护一份“索引表”，也可以说是“字典”（这有点类似brotli），压缩和解压缩就是查表和更新表的操作。</p><p>为了方便管理和压缩，HTTP/2废除了原有的起始行概念，把起始行里面的请求方法、URI、状态码等统一转换成了头字段的形式，并且给这些“不是头字段的头字段”起了个特别的名字——“<strong>伪头字段</strong>”（pseudo-header fields）。而起始行里的版本号和错误原因短语因为没什么大用，顺便也给废除了。</p><p>为了与“真头字段”区分开来，这些“伪头字段”会在名字前加一个“:”，比如“:authority” “:method” “:status”，分别表示的是域名、请求方法和状态码。</p><p>现在HTTP报文头就简单了，全都是“Key-Value”形式的字段，于是HTTP/2就为一些最常用的头字段定义了一个只读的“<strong>静态表</strong>”（Static Table）。</p><p>下面的这个表格列出了“静态表”的一部分，这样只要查表就可以知道字段名和对应的值，比如数字“2”代表“GET”，数字“8”代表状态码200。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage760c769dcf953ddafc4573a0b4c3f0321f0c.f29d38fa.png" alt=""/></p><p>但如果表里只有Key没有Value，或者是自定义字段根本找不到该怎么办呢？</p><p>这就要用到“<strong>动态表</strong>”（Dynamic Table），它添加在静态表后面，结构相同，但会在编码解码的时候随时更新。</p><p>比如说，第一次发送请求时的“user-agent”字段长是一百多个字节，用哈夫曼压缩编码发送之后，客户端和服务器都更新自己的动态表，添加一个新的索引号“65”。那么下一次发送的时候就不用再重复发那么多字节了，只要用一个字节发送编号就好。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage5f6f5fa90e123c68855140e2b40f4f73c56f.33a2b47e.png" alt=""/></p><p>你可以想象得出来，随着在HTTP/2连接上发送的报文越来越多，两边的“字典”也会越来越丰富，最终每次的头部字段都会变成一两个字节的代码，原来上千字节的头用几十个字节就可以表示了，压缩效果比gzip要好得多。</p><h2 id="二进制帧"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#二进制帧"><span class="icon icon-link"></span></a>二进制帧</h2><p>头部数据压缩之后，HTTP/2就要把报文拆成二进制的帧准备发送。</p><p>HTTP/2的帧结构有点类似TCP的段或者TLS里的记录，但报头很小，只有9字节，非常地节省（可以对比一下TCP头，它最少是20个字节）。</p><p>二进制的格式也保证了不会有歧义，而且使用位运算能够非常简单高效地解析。</p><p><img src="data:image/png;base64,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LTIzVDA4OjA5OjI5KzAwOjAwZ/jIUwAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyMy0wOS0yM1QwODowOToyOSswMDowMBalcO8AAAAodEVYdGRhdGU6dGltZXN0YW1wADIwMjMtMDktMjNUMDg6MDk6MjkrMDA6MDBBsFEwAAAAE3RFWHRkYzpmb3JtYXQAaW1hZ2UvcG5n/7kbPgAAABV0RVh0cGhvdG9zaG9wOkNvbG9yTW9kZQAyIQWD1gAAABR0RVh0eG1wOkNvbG9yU3BhY2UANjU1MzU7VE3yAAAAKHRFWHR4bXA6Q3JlYXRlRGF0ZQAyMDE5LTA4LTAxVDE3OjQ1OjUxKzA4OjAwJ00pmQAAADN0RVh0eG1wOkNyZWF0b3JUb29sAEFkb2JlIFBob3Rvc2hvcCBDQyAyMDE3IChNYWNpbnRvc2gpmllTCQAAACp0RVh0eG1wOk1ldGFkYXRhRGF0ZQAyMDE5LTA4LTA1VDE1OjI4OjQ2KzA4OjAwDzzAMQAAACh0RVh0eG1wOk1vZGlmeURhdGUAMjAxOS0wOC0wNVQxNToyODo0NiswODowMDOYk48AAAAYdEVYdHhtcDpQaXhlbFhEaW1lbnNpb24AMTE0Mt8tzksAAAAXdEVYdHhtcDpQaXhlbFlEaW1lbnNpb24ANTc1+RAmAgAAAD10RVh0eG1wTU06RG9jdW1lbnRJRAB4bXAuZGlkOjlhYmJmOTU1LWI1ZGYtNGIxZS1hMjQ1LWU0OTU1ZWY4YTE0Mj7ch/0AAAA9dEVYdHhtcE1NOkluc3RhbmNlSUQAeG1wLmlpZDozOTMxNmU2YS0wMWE5LTQ0NDgtOGY4NS1iOTg2M2FjMTkyMjBuaw2UAAAARXRFWHR4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQAeG1wLmRpZDo5YWJiZjk1NS1iNWRmLTRiMWUtYTI0NS1lNDk1NWVmOGExNDIyAekOAAAAAElFTkSuQmCC" alt=""/></p><p>帧开头是3个字节的<strong>长度</strong>（但不包括头的9个字节），默认上限是2^14，最大是2^24，也就是说HTTP/2的帧通常不超过16K，最大是16M。</p><p>长度后面的一个字节是<strong>帧类型</strong>，大致可以分成<strong>数据帧</strong>和<strong>控制帧</strong>两类，HEADERS帧和DATA帧属于数据帧，存放的是HTTP报文，而SETTINGS、PING、PRIORITY等则是用来管理流的控制帧。</p><p>HTTP/2总共定义了10种类型的帧，但一个字节可以表示最多256种，所以也允许在标准之外定义其他类型实现功能扩展。这就有点像TLS里扩展协议的意思了，比如Google的gRPC就利用了这个特点，定义了几种自用的新帧类型。</p><p>第5个字节是非常重要的<strong>帧标志</strong>信息，可以保存8个标志位，携带简单的控制信息。常用的标志位有<strong>END_HEADERS</strong>表示头数据结束，相当于HTTP/1里头后的空行（“\r\n”），<strong>END_STREAM</strong>表示单方向数据发送结束（即EOS，End of Stream），相当于HTTP/1里Chunked分块结束标志（“0\r\n\r\n”）。</p><p>报文头里最后4个字节是<strong>流标识符</strong>，也就是帧所属的“流”，接收方使用它就可以从乱序的帧里识别出具有相同流ID的帧序列，按顺序组装起来就实现了虚拟的“流”。</p><p>流标识符虽然有4个字节，但最高位被保留不用，所以只有31位可以使用，也就是说，流标识符的上限是2^31，大约是21亿。</p><p>好了，把二进制头理清楚后，我们来看一下Wireshark抓包的帧实例：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage570357b0d1814567e6317c8de1e3c04b7503.61411492.png" alt=""/></p><p>在这个帧里，开头的三个字节是“00010a”，表示数据长度是266字节。</p><p>帧类型是1，表示HEADERS帧，负载（payload）里面存放的是被HPACK算法压缩的头部信息。</p><p>标志位是0x25，转换成二进制有3个位被置1。PRIORITY表示设置了流的优先级，END_HEADERS表示这一个帧就是完整的头数据，END_STREAM表示单方向数据发送结束，后续再不会有数据帧（即请求报文完毕，不会再有DATA帧/Body数据）。</p><p>最后4个字节的流标识符是整数1，表示这是客户端发起的第一个流，后面的响应数据帧也会是这个ID，也就是说在stream[1]里完成这个请求响应。</p><h2 id="流与多路复用"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#流与多路复用"><span class="icon icon-link"></span></a>流与多路复用</h2><p>弄清楚了帧结构后我们就来看HTTP/2的流与多路复用，它是HTTP/2最核心的部分。</p><p>在上一讲里我简单介绍了流的概念，不知道你“悟”得怎么样了？这里我再重复一遍：<strong>流是二进制帧的双向传输序列</strong>。</p><p>要搞明白流，关键是要理解帧头里的流ID。</p><p>在HTTP/2连接上，虽然帧是乱序收发的，但只要它们都拥有相同的流ID，就都属于一个流，而且在这个流里帧不是无序的，而是有着严格的先后顺序。</p><p>比如在这次的Wireshark抓包里，就有“0、1、3”一共三个流，实际上就是分配了三个流ID号，把这些帧按编号分组，再排一下队，就成了流。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage6833688630945be2dd51ca62515ae498db33.4dc0b391.png" alt=""/></p><p>在概念上，一个HTTP/2的流就等同于一个HTTP/1里的“请求-应答”。在HTTP/1里一个“请求-响应”报文来回是一次HTTP通信，在HTTP/2里一个流也承载了相同的功能。</p><p>你还可以对照着TCP来理解。TCP运行在IP之上，其实从MAC层、IP层的角度来看，TCP的“连接”概念也是“虚拟”的。但从功能上看，无论是HTTP/2的流，还是TCP的连接，都是实际存在的，所以你以后大可不必再纠结于流的“虚拟”性，把它当做是一个真实存在的实体来理解就好。</p><p>HTTP/2的流有哪些特点呢？我给你简单列了一下：</p><ol><li>流是可并发的，一个HTTP/2连接上可以同时发出多个流传输数据，也就是并发多请求，实现“多路复用”；</li><li>客户端和服务器都可以创建流，双方互不干扰；</li><li>流是双向的，一个流里面客户端和服务器都可以发送或接收数据帧，也就是一个“请求-应答”来回；</li><li>流之间没有固定关系，彼此独立，但流内部的帧是有严格顺序的；</li><li>流可以设置优先级，让服务器优先处理，比如先传HTML/CSS，后传图片，优化用户体验；</li><li>流ID不能重用，只能顺序递增，客户端发起的ID是奇数，服务器端发起的ID是偶数；</li><li>在流上发送“RST_STREAM”帧可以随时终止流，取消接收或发送；</li><li>第0号流比较特殊，不能关闭，也不能发送数据帧，只能发送控制帧，用于流量控制。</li></ol><p>这里我又画了一张图，把上次的图略改了一下，显示了连接中无序的帧是如何依据流ID重组成流的。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimageb47eb49595a5a425c0e67d46ee17cc212e7e.c03fbd3c.png" alt=""/></p><p>从这些特性中，我们还可以推理出一些深层次的知识点。</p><p>比如说，HTTP/2在一个连接上使用多个流收发数据，那么它本身默认就会是长连接，所以永远不需要“Connection”头字段（keepalive或close）。</p><p>你可以再看一下Wireshark的抓包，里面发送了两个请求“/31-1”和“/favicon.ico”，始终用的是“56095&lt;-&gt;8443”这个连接，对比一下<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/100502">第8讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，你就能够看出差异了。</p><p>又比如，下载大文件的时候想取消接收，在HTTP/1里只能断开TCP连接重新“三次握手”，成本很高，而在HTTP/2里就可以简单地发送一个“RST_STREAM”中断流，而长连接会继续保持。</p><p>再比如，因为客户端和服务器两端都可以创建流，而流ID有奇数偶数和上限的区分，所以大多数的流ID都会是奇数，而且客户端在一个连接里最多只能发出2^30，也就是10亿个请求。</p><p>所以就要问了：ID用完了该怎么办呢？这个时候可以再发一个控制帧“GOAWAY”，真正关闭TCP连接。</p><h2 id="流状态转换"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#流状态转换"><span class="icon icon-link"></span></a>流状态转换</h2><p>流很重要，也很复杂。为了更好地描述运行机制，HTTP/2借鉴了TCP，根据帧的标志位实现流状态转换。当然，这些状态也是虚拟的，只是为了辅助理解。</p><p>HTTP/2的流也有一个状态转换图，虽然比TCP要简单一点，但也不那么好懂，所以今天我只画了一个简化的图，对应到一个标准的HTTP“请求-应答”。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimaged3b4d389ac436d8100406a4a488a69563cb4.ec7882b1.png" alt=""/></p><p>最开始的时候流都是“<strong>空闲</strong>”（idle）状态，也就是“不存在”，可以理解成是待分配的“号段资源”。</p><p>当客户端发送HEADERS帧后，有了流ID，流就进入了“<strong>打开</strong>”状态，两端都可以收发数据，然后客户端发送一个带“END_STREAM”标志位的帧，流就进入了“<strong>半关闭</strong>”状态。</p><p>这个“半关闭”状态很重要，意味着客户端的请求数据已经发送完了，需要接受响应数据，而服务器端也知道请求数据接收完毕，之后就要内部处理，再发送响应数据。</p><p>响应数据发完了之后，也要带上“END_STREAM”标志位，表示数据发送完毕，这样流两端就都进入了“<strong>关闭</strong>”状态，流就结束了。</p><p>刚才也说过，流ID不能重用，所以流的生命周期就是HTTP/1里的一次完整的“请求-应答”，流关闭就是一次通信结束。</p><p>下一次再发请求就要开一个新流（而不是新连接），流ID不断增加，直到到达上限，发送“GOAWAY”帧开一个新的TCP连接，流ID就又可以重头计数。</p><p>你再看看这张图，是不是和HTTP/1里的标准“请求-应答”过程很像，只不过这是发生在虚拟的“流”上，而不是实际的TCP连接，又因为流可以并发，所以HTTP/2就可以实现无阻塞的多路复用。</p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#小结"><span class="icon icon-link"></span></a>小结</h2><p>HTTP/2的内容实在是太多了，为了方便学习，我砍掉了一些特性，比如流的优先级、依赖关系、流量控制等。</p><p>但只要你掌握了今天的这些内容，以后再看RFC文档都不会有难度了。</p><ol><li>HTTP/2必须先发送一个“连接前言”字符串，然后才能建立正式连接；</li><li>HTTP/2废除了起始行，统一使用头字段，在两端维护字段“Key-Value”的索引表，使用“HPACK”算法压缩头部；</li><li>HTTP/2把报文切分为多种类型的二进制帧，报头里最重要的字段是流标识符，标记帧属于哪个流；</li><li>流是HTTP/2虚拟的概念，是帧的双向传输序列，相当于HTTP/1里的一次“请求-应答”；</li><li>在一个HTTP/2连接上可以并发多个流，也就是多个“请求-响应”报文，这就是“多路复用”。</li></ol><h2 id="课下作业"><a aria-hidden="true" tabindex="-1" href="/blog-base/详解http/06.飞翔篇/02#课下作业"><span class="icon icon-link"></span></a>课下作业</h2><ol><li>HTTP/2的动态表维护、流状态转换很复杂，你认为HTTP/2还是“无状态”的吗？</li><li>HTTP/2的帧最大可以达到16M，你觉得大帧好还是小帧好？</li><li>结合这两讲，谈谈HTTP/2是如何解决“队头阻塞”问题的。</li></ol><p>欢迎你把自己的学习体会写在留言区，与我和其他同学一起讨论。如果你觉得有所收获，也欢迎把文章分享给你的朋友。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage3d493dfab162c427fb3a1fa16494456ae449.bcfe2820.png" alt="unpreview"/></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/详解http/06.飞翔篇/02.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 20:27:01</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-base/umi.js"></script>
  </body>
</html>
