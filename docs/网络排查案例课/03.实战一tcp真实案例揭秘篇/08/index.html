<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-base/umi.css" />
    <script>
      window.routerBase = "/blog-base";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>09 | 长肥管道：为何文件传输速度这么慢？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/网络排查案例课/03.实战一tcp真实案例揭秘篇/08" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></span><span>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></span><span>前端工程化</span><span>前端性能优化</span><span>移动端开发</span><span>软件测试</span><span>产品与用户体验</span><span>面试</span><span>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></li><li>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></li><li>前端工程化</li><li>前端性能优化</li><li>移动端开发</li><li>软件测试</li><li>产品与用户体验</li><li>面试</li><li>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/网络排查案例课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-base/网络排查案例课/01.开篇词/01"><span>开篇词 | 网络排查是工程师的必备能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/02.预习篇">02.预习篇</a><ul><li><a href="/blog-base/网络排查案例课/02.预习篇/01"><span>01 | 网络模型和工具：网络为什么要分层？</span></a></li><li><a href="/blog-base/网络排查案例课/02.预习篇/02"><span>02 | 抓包分析技术初探：你会用tcpdump和Wireshark吗？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇">03.实战一TCP真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/01"><span>03 | 握手：TCP连接都是用TCP协议沟通的吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/02"><span>04 | 挥手：Nginx日志报connection reset by peer是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/03"><span>05 | 定位防火墙（一）：传输层的对比分析</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04"><span>答疑（一）| 第1~5讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/05"><span>06 | 定位防火墙（二）：网络层的精确打击</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06"><span>07 | 保活机制：心跳包异常导致应用重启？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/07"><span>08 | 分段：MTU引发的血案</span></a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08"><span>09 | 长肥管道：为何文件传输速度这么慢？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/09"><span>10 | 窗口：TCP Window Full会影响传输效率吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/10"><span>答疑（二）| 第6~10讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/11"><span>11 | 拥塞：TCP是如何探测到拥塞的？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/12"><span>12 | 重传的认识：重传到底是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/13"><span>13 | 重传的再认识：没有任何丢包却也一直重传？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/14"><span>14 | 安全：用Wireshark把DDoS攻击照出原形</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送">04.春节特别放送</a><ul><li><a href="/blog-base/网络排查案例课/04.春节特别放送/01"><span>春节特别放送（一）| 书单推荐</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/02"><span>春节特别放送（二）| 聊聊能力陷阱和终身学习</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/03"><span>春节特别放送（三）| 我的学习资料和工具</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/04"><span>春节特别放送（四）| 测一测你的网络排查能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇">05.实战二应用层真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/01"><span>15 | Nginx的499状态码是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/02"><span>答疑（三）| 第11~15讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/03"><span>16 | 服务器为什么回复HTTP 400？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/04"><span>17 | 为什么前端页面里多选一个城市就报错？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/05"><span>18 | 偶发性问题如何排查？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/06"><span>19 | TLS的各种特性：TLS握手为什么会失败？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/07"><span>20 | TLS加解密：如何解密HTTPS流量？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/08"><span>答疑（四）| 第16~20讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/09"><span>21 | 为什么用了负载均衡更加不均衡？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/10"><span>22 | 为什么压力测试TPS总是上不去？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇">06.实战三不用抓包就能做的网络排查篇</a><ul><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/01"><span>23 | 路径排查：没有网络设备权限要如何做排查？</span></a></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/02"><span>24 | 丢包：如何确定丢包的存在及其程度？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐">07.不定期加餐</a><ul><li><a href="/blog-base/网络排查案例课/07.不定期加餐/01"><span>不定期加餐（一） | 八仙过海，各显神通：透传真实源IP的各种方法</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/02"><span>用户故事 | 小S：学习是人生路上生生不息的活泉</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/03"><span>用户故事 | 王未：网络排查能力是一名合格运维工程师的必备技能</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/08.总结篇">08.总结篇</a><ul><li><a href="/blog-base/网络排查案例课/08.总结篇/01"><span>25 | 抓包分析的回顾、拾遗，和提高</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/02"><span>结束语 | 珍惜握手，难说再见</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/03"><span>结课测试 | “网络排查案例课”100分试卷等你来挑战！</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/summary">网络排查案例课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="案例背景" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#案例背景"><span>案例背景</span></a></li><li title="I/O Graph" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#io-graph"><span>I/O Graph</span></a></li><li title="TCP Stream Graphs" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#tcp-stream-graphs"><span>TCP Stream Graphs</span></a></li><li title="理解与传输相关的知识点" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#理解与传输相关的知识点"><span>理解与传输相关的知识点</span></a></li><li title="解题" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#解题"><span>解题</span></a></li><li title="时延" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#时延"><span>时延</span></a></li><li title="带宽时延积" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#带宽时延积"><span>带宽时延积</span></a></li><li title="发送窗口" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#发送窗口"><span>发送窗口</span></a></li><li title="最后的疑问" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#最后的疑问"><span>最后的疑问</span></a></li><li title="小结" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#思考题"><span>思考题</span></a></li><li title="附录" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#附录"><span>附录</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="09--长肥管道为何文件传输速度这么慢"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#09--长肥管道为何文件传输速度这么慢"><span class="icon icon-link"></span></a>09 | 长肥管道：为何文件传输速度这么慢？</h1><p>你好，我是胜辉。</p><p>在上节课里，我们通过一个MTU引发问题的案例，学习了MTU相关的知识点，了解了MTU、MSS、TCP分段、IP分片这些概念之间的区别和联系。我们也学习了用iptables修改MSS来达到规避MTU问题的目的，是不是觉得网络虽然学起来不简单，但学会了好像也挺好玩的？</p><p>那这个感觉就对了，学习本来就是一件有意思的事情，也是很有收获感的事情。学得更多，收益更多，反过来就能推动自己继续学得更多，形成良性循环。</p><p>当然，上节课我们主要说的是如果传输失败会怎么样，而从这节课开始，我们会讨论讨论传输起来以后的效率问题，比如传输速度。</p><p><strong>传输速度</strong>是网络性能中非常重要的一部分内容，因为它直接影响了我们享受到的网络服务的品质。比如现在移动端网络越来越快，所以无论传输大文件还是实时的视频通话，都得到了很大的发展。</p><p>数据中心更是如此。服务器的网卡早就从多年前的千兆网卡（1Gbps）升级到万兆网卡（10Gbps）。而负载均衡、防火墙等网络设备，更是从10Gbps升级到40Gbps，乃至100Gbps。</p><p>在这个大背景下，照理说在数据中心之间传个文件早已不在话下。但是我们偏偏遇到了这样一个奇葩的问题：<strong>数据中心间传输文件的速度居然只有400多KB/s</strong>，是不是很奇怪？你有没有遇到过类似的传输速度方面的问题，你又是如何通过网络分析，找到根因的呢？</p><p>所以这节课，我们就来研究分析下这个文件传输速度的案例，一起来深入探讨下如何提升TCP传输速度的话题。</p><p>这样，当你日后也遇到传输速度方面的问题时，就可以运用这节课学到的知识，去真正解决问题。甚至，即使看起来没有速度问题，你也能主动发现提高网络性能的机会，带来额外的惊喜，同时也把你的网络维护的能力提升到一个更高的层次上来。</p><h2 id="案例背景"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#案例背景"><span class="icon icon-link"></span></a>案例背景</h2><p>这是2017年我处理的eBay内部的案例。当时我们有一个需求是把一个Firmware安装文件从美国数据中心拷贝到欧洲的一个POP点，这个点在荷兰的阿姆斯特丹。文件不算大，95MB。其实这是一项常规任务，因为我们每年都会做一到两次的Firmware升级，经常在美国几个数据中心之间拷贝安装文件，一般这样一个100MB左右的文件约二十多秒就能完成。</p><p>这一次，我们需要把全球POP节点的设备也进行升级。对我们来说，确实也是第一次做从北美到欧洲这么长距离的文件传输，结果发现传输速度慢了一个数量级。我们的POP点有很多个，按顺序做升级的话，每次文件传输都增加3分钟，那么20个POP就增加60分钟，显著拖累了整个的升级速度。</p><p>当然，地理上看，从美国加州到荷兰阿姆斯特丹确实极为遥远，距离数千公里，坐飞机也要14个多小时：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage3da23d731a2563eb2c38aa91484ab92829a2.png" alt="图片"/></p><p>然后我们也来看一下美国不同的数据中心之间拷贝的速度：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagec0dcc0713e2fb303be50437c51d732b458dc.jpg" alt=""/></p><p>再看一下从美国拷贝到荷兰的速度：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagef14ff118bc63c49feae0337abdbcdfaa454f.jpg" alt=""/></p><p>当你看到两种场景下传输同一个文件的速度有这么大的差别，第一感觉是什么呢？你觉得会是什么因素导致了速度变这么慢？会不会想到带宽？</p><p>确实，当时我们也才开始维护欧洲POP点，对美国和欧洲之间的底层传输网络情况并不熟悉，所以也怀疑：**会不会是带宽本身就不大呢？**我们找了负责骨干网的同事，了解到这个带宽有10Gbps，远超这个传输速度。</p><p>然后，你会想到什么呢？对了，我补充一下：这个传输是scp拷贝，所以是基于TCP的。你自然明白，TCP的传输速度也受丢包的影响。如果丢包严重，传输速度肯定跑不起来。我们觉得这个也是有可能的，就去抓包检查。结果发现丢包率并不高，不高的丢包率却导致如此低的速度，这个可能性很小。</p><p>更为重要的是，<strong>既然我们要排查传输速度的问题，那么首先要看的，是不是网络I/O的状况呢？</strong></p><blockquote><p>补充：抓包示例文件已经传输至<a target="_blank" rel="noopener noreferrer" href="https://gitee.com/steelvictor/network-analysis/tree/master/09">Gitee<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，建议用Wireshark打开示例文件，结合文稿学习，效果更好。</p></blockquote><p>在Wireshark的众多统计工具中，有两个工具就是I/O分析而生的，一个是 <strong>I/O Graph</strong>，另一个是 <strong>TCP Stream Graph</strong>。我们先看I/O Graph。</p><h2 id="io-graph"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#io-graph"><span class="icon icon-link"></span></a>I/O Graph</h2><p>这个工具在Statistics下拉菜单中：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage48e2481e6a312e60b8bb7455340719de37e2.png" alt="图片"/></p><p>点击I/O Graph后，Wireshark会弹出一个趋势图，其X轴是时间，Y轴是性能指标：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage3be23b012aec31994547cfa0ec86fb01bee2.png" alt="图片"/></p><p>注意，这时的图是不准确的，所以我们需要做一些调整。既然我们关注传输速度，所以就选择All Bytes这个指标项（也是默认选中的那项）作为Y轴，然后修改它的计量单位。很可能你的Wireshark默认选中的是AVG(Y Field)，而这并不是我们要关注的<strong>字节数</strong>。我们可以双击AVG(Y Field)进入编辑模式，把它改为<strong>Bytes</strong>：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagee3c5e355081c0c2f0f3a34bd9885902692c5.png" alt="图片"/></p><p>很棒！这时我们就能清晰地看到，Wireshark帮助我们计算出来的分时的速度趋势柱状图了，差不多速度在480KB/s上下：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimageeb74eb3249ec5973ffa8b92da250965db774.jpg" alt="图片"/></p><p>你可能也注意到了，在X时间轴上看，一开始几秒速度比较低，第7秒才达到400KB/s以上。为什么一开始速度这么低呢？其实，这正是TCP慢启动的一个缩影：<strong>初始阶段，速度是特别低的，但是会很快爬高</strong>。</p><p>整体来看，这个传输速度还是很“稳定”的。对，一直很“稳定”得低。</p><h2 id="tcp-stream-graphs"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#tcp-stream-graphs"><span class="icon icon-link"></span></a>TCP Stream Graphs</h2><p>如果说I/O Graph展示的速度值很容易理解，那么TCP Stream Graphs展示的信息就需要一点TCP的知识来辅助理解了。</p><p>还是到Statics下拉菜单，选择TCP Stream Graphs，在子菜单中选择Time sequence (Stevens)。</p><blockquote><p>补充：Stevens这个名字你应该是熟悉的，他就是鼎鼎大名的TCP/IP三卷和Unix网络编程两卷等名著的作者，Richard Stevens。他把网络协议的圣火带到人间，却又早早离开了人间。这个工具以他的名字命名，也代表了大家对他的深深的怀念。</p></blockquote><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage53d253cff83679be9c7399136d76a2e8d2d2.jpg" alt="图片"/></p><p>然后就能看到时间为X轴、TCP序列号为Y轴的图了。你应该知道，序列号其实就等于字节数，那么显然，这里这条线的斜率也就是传输速率了。</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagec49ec4e9b272905c8478c282d66026ae399e.jpg" alt="图片"/></p><p>我们可以自己计算这个斜率（速率） 是多少。比如可以计算10秒和40秒两处的序列号的差距，再除以(40-10)秒，就是速率了。10秒处的序列号是2800092，40秒处是16480292，那么速率就是(16480292-2800092)/(40-10)=456KB/s。</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage7aeb7af63950d3bdb4f7b0cf7d5d3d08f7eb.jpg" alt="图片"/></p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage6ac16a48f093cayycf2c2db93946833d22c1.jpg" alt="图片"/></p><p>你可能发现了，**两个Graph算出来的速度怎么有点差异？**一个是480KB/s左右，一个是456KB/s，相差有5%左右。</p><p>其实，这是正常的。因为I/O Graph统计的Bytes是二层帧的大小，而TCP Stream Graphs关注的是四层TCP段的大小。后者比前者少了二层到四层的头部。严格来说，TCP Stream Graphs的斜率，只是TCP payload的速率；而I/O Graph展示的，才是我们一般谈论的传输速度。当然，在定性的讨论中，这点差异是可以忽略的。</p><h2 id="理解与传输相关的知识点"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#理解与传输相关的知识点"><span class="icon icon-link"></span></a>理解与传输相关的知识点</h2><p>其实，上面用了两种方式查证速度，也无非是印证了我们在scp命令输出里，看到的速度值本身是准确的。但目前为止，我们还没有找到造成这个速度的原因。这时候，我们稍微调整一下问题描述：<strong>假如带宽足够，网络也稳定，那又是什么决定了TCP传输的速度？</strong></p><p>回想一个小学时就学过的公式：<strong>速度=距离/时间</strong>。</p><p>看上去极为简单的公式，似乎在这里没什么帮助。不过奥妙的地方在于：什么是距离，什么又是时间？搞清楚了这两个问题的答案，就搞清楚了这次传输分析的精髓。不过我这里先卖个关子，先继续把接下来的知识点讲清楚，到后面你也许自己就能悟到答案了。</p><p>假设你在开车，开出去100公里，耗时1小时。这是因为你眼观四路、耳听八方，在确保安全的前提下用比较快的速度行驶。如果你蒙上眼睛，那是1米都不敢开的，是不是？</p><p>对于网络传输来说，报文发送出去后，发送端本身就“失去视力”了，也就是看不到报文在错综复杂的网络中行走时，到底遇到了什么样的“路况”。那它是继续发送更多数据好呢，还是先等对方确认这部分数据，然后再发送下一份数据好呢？如果确认了，那下一份数据又该发多少呢？一系列问题，需要我们回答。</p><p>不过还好，睿智的TCP的设计者们早就考虑到了这些问题。这里呢，有几个相关知识点你需要了解，且听我细细道来。</p><p>首先，一个报文被视为成功发送，基于以下的路径：</p><p><strong>（开始）发送端&gt;&gt;数据报文&gt;&gt;接收端&gt;&gt; ACK报文&gt;&gt;发送端（结束）</strong></p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage191e19d0e832824c49c76e86393c7e01461e.jpg" alt=""/></p><p>这样一来一回的时间，就是报文被成功传送的耗时。你可能会有疑问：数据报文到了接收端不就是已经完成传输了吗？其实，这个时候发送端还不知道接收端是否已经完成接收了，因为还没收到确认。</p><p>从<strong>操作系统的角度</strong>来看：“完成”的标志，是这部分数据可以从发送缓存中删除；从缓存中删除这部分数据的前提，就是收到ACK报文。即“确认多少，我就清除多少”。像下图这样：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagef9a1f91abcdffbe68392e84ea36271126ba1.jpg" alt=""/></p><p>来回的时间，在英文里叫 <strong>Round Trip Time</strong>（RTT），即往返时间，也叫<strong>时延</strong>。这是你需要知道的第一个名词。</p><p>你有没有发现，报文大部分时候就像飞机在空中航行，跟两端的哪一端都碰不着，除了起飞和降落。在“空中”的时间，就取决于RTT。RTT越长，报文在“空中”的时间就越长。这个时候，这些报文就有了一个新的身份，叫做“在途数据”，它的大小，叫做<strong>在途字节数</strong>。英文是 <strong>Bytes in flight</strong>。这是你需要知道的第二个名词。</p><p>事实上，Wireshark也很周到地帮我们想到了这一点，在TCP详情页的SEQ/ACK analysis部分就有 <strong>Bytes in flight</strong> 信息。比如下面这个：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimageba09ba46c99c183c40eaa20c77b4d47ace09.png" alt="图片"/></p><p>带宽，类似道路的车道数，你应该见过节假日里高速公路上停满私家车的图片。可见，车道越多，高速路越长，能容纳的车就越多。在网络世界里，带宽很大、RTT很长的网络，被冠以一个特定的名词，叫做<strong>长肥网络</strong>，英文是 <strong>Long Fat Network</strong>。在长肥网络中的TCP连接，叫做<strong>长肥管道</strong>，英文是 <strong>Long Fat Pipeline</strong>。这是你需要知道的第三个名词。</p><p>道路上最多可以容纳多少辆车呢？显然，是车道数×道路长度。那么类似地，带宽跟往返时间（RTT）相乘，就是在空中飞行的报文的最大数量，即<strong>带宽时延积</strong>。在英文里叫 <strong>Bandwidth Delay Product</strong>，缩写是BDP（Delay就是RTT）。不用我说，你也明白带宽时延积是你需要知道的第四个名词。</p><p>其实，以上这些名词都是从英文翻译过来的，所以读起来感觉不太像本土词汇，特别是“长肥管道”。你别把“长肥”记成“肥肠”就行了。</p><p>我们用图对比一下，就能明显看出，所谓的长肥管道，就是带宽时延积更大的网络，蓝色部分表示的就是带宽时延积：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage762c76a904603f912942afaaa5074b114c2c.jpg" alt=""/></p><p>你可能还会有疑问，在途数据不是应该RTT的一半（即单程时间）再乘以带宽吗？从飞机的比喻来看，也许是的。但是你要考虑下图这种情况。如果回程时间只是用来传输ACK，没有被用来传输实际的数据，效率就打了对折了。就像图的右侧表示的，只有一半的时间在真正传输数据，另外一半时间没有在发送数据：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage6d036d5fa4b8b550d11df2f5a20c830c9f03.jpg" alt=""/></p><p>事实上，发送端并不知道什么时候报文到了接收端，它唯一知道的是什么时候自己收到了ACK报文，所以它会把这些时间全部用来发送报文。我把上图中原先不传数据的时间段2和4也改为发送数据，于是形成了下面这张图：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagee24ee214329cb79fbea930895e2a9c20484e.jpg" alt=""/></p><p>当然，<strong>实际情况是远比示意图复杂的</strong>。比如，在途字节数一定等于<code>带宽×RTT</code>吗？要知道，接收端也不傻，也是可以源源不断地对数据进行确认的，这样也就形成了更加复杂的关系：发送端在不断发出在途数据，接收端也在不断回复ACK。这时候的在途数据，可以用下面的公式来获得：</p><blockquote><p><strong>inflight_data = (latest_sequence_sent + latest_len_sent) - max_ack_received</strong></p></blockquote><p>最后还有个重要的概念是“窗口”。有人开玩笑说：讨论TCP握手的时候，大家侃侃而谈；一旦说到窗口，就都沉默了，气氛尴尬。继续往下学习这一部分，你会成为那个打破沉默的人。<code>：）</code></p><p>其实，下次别人跟你切磋“窗口技术”的时候，可以先下手为强：“你说的是到底哪个窗口？”因为事实上，TCP有3个窗口：接收窗口、拥塞窗口，还有发送窗口。</p><ul><li><strong>接收窗口</strong>：它代表的是接收端当前最多能接收的字节数。通过TCP报文头部的Window字段，通信双方能互相了解到对方的接收窗口。</li><li><strong>拥塞窗口</strong>：发送端根据实际传输的拥塞情况计算出来的可发送字节数，但不公开在报文中。各自暗地里各维护各的，互相不知道，也不需要知道。</li><li><strong>发送窗口</strong>：对方的接收窗口和自身的拥塞窗口两者中，值较小者。实际发送的在途字节数不会大于这个值。</li></ul><p>接收窗口是明的，在抓包文件里就能看到；拥塞窗口和发送窗口是暗的，抓包文件里没有。我们看这张图就明白了：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage687568bdddb151cbd999ca3b819bfcb13375.jpg" alt=""/></p><h2 id="解题"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#解题"><span class="icon icon-link"></span></a>解题</h2><p>好了，终于把传输相关的关键知识点介绍完了，是不是感觉信息量有点大，甚至还没完全理解？别急，下面我们把这些知识点应用到这个案例中，这些看似干涩的知识点就会逐步丰润起来。</p><h3 id="时延"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#时延"><span class="icon icon-link"></span></a>时延</h3><p>我们首先收集时延信息。用美国数据中心的发送端去Ping阿姆斯特丹接收端的IP，我们发现<strong>时延在134ms</strong> 左右。用Ping的原因是，它的ICMP报文比较轻量，不会引起双方很多的额外处理时间，所以适合用来获取相对纯粹的网络往返时间。</p><p>在TCP通信中，因为协议栈本身也需要做拆解包、缓冲、Socket处理等工作，所以TCP层面的RTT会比IP层面的RTT略长一点。好在，Wireshark也提供了RTT信息。我们选取一个报文，在TCP详情的SEQ/ACK analysis部分，就有iRTT信息。这里是141ms，比Ping探测到的134ms多了一点，这是因为TCP协议栈本身处理也有一些延迟：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage8fe78f68052f3b9e753b9ed7749c5d4a2fe7.jpg" alt="图片"/></p><p>iRTT是intial RTT的缩写，Wireshark就是从TCP握手阶段的报文里计算出这个值的。对于客户端来说，就是发出SYN和收到SYN+ACK的间隔。对于服务端，就是发出SYN+ACK和收到ACK的间隔。</p><h3 id="带宽时延积"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#带宽时延积"><span class="icon icon-link"></span></a>带宽时延积</h3><p>接下来我们算算带宽时延积是多少。时延是134ms，带宽是10Gbps，那么带宽时延积就是0.134×10Gb。转换为Byte需要再除以8，得到约168MB。这个数值的意思是，假设这条链路完全被这次的文件传输连接所占满，那么最多可以有168MB的在途数据。</p><p>我们这个Firmware文件也才95MB，如果按这个速度，那一个来回就传完了，也就是只需要134ms！当然，TCP有慢启动机制，不可能一开始就把一百多MB这么大的数字作为初始拥塞窗口，所以也不会真的一个来回就传完了。</p><p>到这一步，我们已经明白，<strong>带宽时延积并不是限制速度的因素</strong>。那么一定是别的东西，在暗地里约束着这次传输。这个东西是什么呢？我们快接近真相了。</p><h3 id="发送窗口"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#发送窗口"><span class="icon icon-link"></span></a>发送窗口</h3><p>在Wireshark里查看接收窗口的数值也是很直观的。任意一个TCP报文的头部都有Window字段，长度为2个字节，所以最大值为2的16次方，即64KB。在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/479163">第3讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>我们讨论TCP握手相关案例时，提到过<strong>Window Scale</strong>。它是在<a target="_blank" rel="noopener noreferrer" href="https://datatracker.ietf.org/doc/html/rfc1323">RFC1323<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中引进的，使得Window值最大能达到2的30次方，即1GB。</p><p>我们看一下当时阿姆斯特丹POP点作为接收端，它宣告给美国数据中心的TCP接收窗口值是多少。为了方便查看，你可以在Wireshark里这样做：</p><ul><li><strong>添加Calculated window size为自定义列</strong>。操作方法是任选一个TCP报文，在TCP详情那里找到[Calculated window size:xxxx]，右单击，在弹出菜单中点击Apply as Column。然后主窗口里就多了这样一列Calculated window size。</li><li><strong>在过滤器输入框输入tcp.srcport eq 22</strong>，这样就把POP点（监听在22端口）发出的报文过滤出来了，更加方便我们查看。</li></ul><p>我得到的界面是这样的：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage15ee154e401f906f5d43b86897c43e66c3ee.jpg" alt="图片"/></p><p>左上角是过滤器，右侧第二列就是刚刚新添加的Calculated window size。显然，能从图中看出，传输起始阶段有不少重传。不过没关系，让我们集中注意力到接收窗口值上。</p><p>由图可见，这个阶段的接收窗口是64KB上下浮动，值偏小。照理来说，传输稳定阶段，接收窗口会大很多，也就应该会比64KB大不少吧？我们往下翻，滚动到整体报文的中间位置，看看此时接收窗口值是多少：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagee023e02fb7d982b909055d476c6c8e6a3223.jpg" alt="图片"/></p><p>有点意外，不仅没有上升，反而偶尔还略微下降了，在54~64KB之间浮动。这是怎么回事？这跟速度慢是否有关系？</p><p>前面提到过，发送端实际的发送窗口是拥塞窗口和对方接收窗口这两者中的较小者。那究竟是多少呢？我们可以这么找到它：</p><ul><li>选中传输中的一个报文，在TCP详情的[SEQ/ACK analysis]部分，找到[Bytes in flight]。</li></ul><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimagef980f97f073b3f9197383c6ba5dfc842bf80.jpg" alt="图片"/></p><ul><li>然后右单击，选中Apply as column。</li></ul><p>主界面里有Bytes in flight这一列后，你就可以排序，下图中显示，这次传输的客户端在途字节数最大是65700，接近64KB，这就是发送窗口。</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage7e507ef67069370fa0d67a46799308115f50.jpg" alt="图片"/></p><p>64KB很小啊，这就相当于，在一个长肥网络中，存在着一个“瘦”很多的管道，完全没有把带宽利用起来。我觉得可以叫做“长瘦管道”。</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage3d223d02b1dc03bdc5d93fa2c024b8591022.jpg" alt=""/></p><p>这个长瘦管道的传输速度是多少呢？在这个案例里，发送窗口=接收窗口，那么在网络上跑的数据量最多就是64KB。那传输这64KB的耗时是多久呢？这不就是往返时间RTT吗？现在，你是否终于回想起前面我卖关子的那个小学公式呢？</p><blockquote><p><strong>速度 = 距离/时间</strong></p></blockquote><p>所以，这次的传输速度的上限就是window/RTT = 64KB/134ms = <strong>478KB/s</strong>！还记得前面用TCP Stream Graphs(Stevens)斜线图得到的速率吗？那个是456KB/s。可见，实际值只比上限值略低，说明虽然窗口很小，但传输过程本身还是比较充分地利用了这个有限的窗口。</p><p>整个案件得以真相大白：限制速度的最大因素，既不是带宽，也不是丢包，而是<strong>窗口</strong>，确切地说就是<strong>接收端（POP点）的接收窗口</strong>。因为这些接收端的设备比较特殊，沿用了老旧的配置，导致TCP接收窗口过小。</p><p>窗口小是因为Window Scale没被启用吗？我们检查发现，Window Scale其实启用了，你可以回头看一下窗口值的截图，有几次的值是65728，明确超过了65535。另外，在握手包里也可以看到Window Scale被启用的信息：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage0ce00ce22e90fecc80c194b183cb572ca6e0.jpg" alt="图片"/></p><blockquote><p>红框中的 <code>TCP Option-Windows scale: 6</code> 就是表示窗口系数（Scale Factor）为6，即2的6次方（得64）。也就是说，真正的接收窗口值，是Window字段的值乘以64。</p></blockquote><p>**那为什么启用了Window Scale，还是被限制在64KB附近呢？**我们发现，这还是受限于这台设备本身的特点。在某些情况下，这里的Window Scale虽然启用了，但无法充分工作，导致实际上这台设备的接收窗口一直被压制在64KB附近。</p><p>想象一下，发送端每次“喂到”网络上的数据只有64KB，这64KB还需要经过134ms后才能到达接收端。然后就这样周而复始，直到全部的95MB发送完成。明明是很宽敞的网络，但可惜，对端的收发室太小了，你只好把大货车停车库里，改开电瓶车，一小车一小车地送货，你急也没用。这速度，哪里还起得来？</p><p>我们对它的配置做了修改，使得接收窗口大幅增加后，速度马上提上去很多倍，这才彻底解决了问题。</p><h2 id="最后的疑问"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#最后的疑问"><span class="icon icon-link"></span></a>最后的疑问</h2><p>不过你是否留意到了，难道当时美国本土数据中心里面的设备就没有这个问题吗？如果也是用了这个老旧的配置，难道就没有传输慢的问题吗？</p><p>我给你的答案是：其实也是老旧的配置，其实速度也是慢的。但是为什么这个问题就没有被暴露呢？这又是跟前面的知识点有关系了。你能想到是哪个因素掩盖了这个问题吗？</p><p>这次的答案不是窗口，而是<strong>往返时间</strong>。在美国本土的多个数据中心之间，RTT大约在10ms多一点，也就是只有美国到荷兰的134ms的十分之一。联系公式“<strong>速度=距离/时间</strong>”，分子（接收窗口）不变，分母（时延）变为原来的十分之一，那么速度会变成原来的十倍。十倍的速度就没有显得那么慢了，所以并没有引起我们的注意。</p><p>我用一个图表示一下这种RTT的不同引起的传输上的区别：</p><p><img src="/images/%E7%BD%91%E7%BB%9C%E6%8E%92%E6%9F%A5%E6%A1%88%E4%BE%8B%E8%AF%BE/03.%E5%AE%9E%E6%88%98%E4%B8%80TCP%E7%9C%9F%E5%AE%9E%E6%A1%88%E4%BE%8B%E6%8F%AD%E7%A7%98%E7%AF%87/resourceimage290429f1ae041993e7181e989e04ebd3f504.jpg" alt=""/></p><p>你看，传输速度的问题，可以说就是窗口和往返时间这两个大玩家在起作用。你只要<strong>抓住这两个主要矛盾，就能解决大部分传输速度的问题</strong>了。其他因素也可能有它的作用，但一般不是核心矛盾。我们要学会抓重点，这对于工作，乃至对于人生，都是很有意义的。</p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#小结"><span class="icon icon-link"></span></a>小结</h2><p>这节课，我用了一个典型的文件传输的案例，帮你回顾了跟TCP传输有关的方方面面的知识点，包括：</p><ul><li><strong>时延</strong>：也叫往返时间，是通信两端之间的一来一回的时间之和。</li><li><strong>在途报文</strong>：发送端已经发出但还未被确认的报文，时延越长，发送窗口越大，在途报文可能越多，这两者是正比关系。</li><li><strong>带宽时延积</strong>：带宽和时延的乘积，表示这个网络能承载的最多的在途数据量。</li><li><strong>发送窗口</strong>：发送窗口是拥塞窗口和对方接收窗口两者中的较小值。</li></ul><p>基于以上的知识，我们得以推导出最终的<strong>核心公式：速度上限=发送窗口/往返时间</strong>。用英文可以表示为：velocity = window/RTT。</p><p>以后你在处理TCP传输速度问题的时候，一样可以应用上面这些知识：先获取时延，再定位发送窗口，最后用这个公式去得到速度的上限值。</p><p>除了这些TCP的知识点，我也提到了使用Wireshark的一些技巧，包括：</p><ul><li><strong>查看I/O Graph的方法</strong>，这个可以直观地展示数据传输的速度。</li><li><strong>查看TCP Stream Graphs的方法</strong>，这个能看到TCP序列号随着时间的变化趋势，同时也可以经过简单计算推导出TCP载荷的传输速度（因为没有计入各种报文头部，这个值比#1的速度值要略低一些）。</li><li><strong>查看TCP Window Scale是否启用</strong>，以及启用的话，Scale Factor的值的查找方法。</li></ul><p>总而言之，你在自己处理类似的传输速度、延迟等问题的时候，一方面可以充分利用我分享的协议方面的知识，获得坚实的理论支撑；一方面也可以使用这节课提到的这些Wireshark分析技巧，获得数据上的支持。当你把理论和数据这两条“腿”都锻炼健壮后，你一定能在网络排查的世界里，更加坚定有力地前行。</p><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>你有没有在工作中遇到过TCP传输速度相关的问题呢？通过这节课的学习，你已经掌握了传输速度相关的不少知识，你准备怎么运用这些知识，来解决这个传输问题呢？</p><p>欢迎在留言区分享出你的答案和思考过程，也欢迎你把今天的内容分享给更多的朋友，我们一起成长。</p><h2 id="附录"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08#附录"><span class="icon icon-link"></span></a>附录</h2><p>抓包示例文件：<a target="_blank" rel="noopener noreferrer" href="https://gitee.com/steelvictor/network-analysis/tree/master/09">https://gitee.com/steelvictor/network-analysis/tree/master/09<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/网络排查案例课/03.实战一TCP真实案例揭秘篇/08.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 16:08:52</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-base/umi.js"></script>
  </body>
</html>
