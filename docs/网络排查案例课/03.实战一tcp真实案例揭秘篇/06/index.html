<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-base/umi.css" />
    <script>
      window.routerBase = "/blog-base";
    </script>
    <script>
      window.publicPath = window.resourceBaseUrl || "/blog-base/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>07 | 保活机制：心跳包异常导致应用重启？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/网络排查案例课/03.实战一tcp真实案例揭秘篇/06" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></span><span>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></span><span>前端工程化</span><span>前端性能优化</span><span>移动端开发</span><span>软件测试</span><span>产品与用户体验</span><span>面试</span><span>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></li><li>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></li><li>前端工程化</li><li>前端性能优化</li><li>移动端开发</li><li>软件测试</li><li>产品与用户体验</li><li>面试</li><li>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/网络排查案例课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-base/网络排查案例课/01.开篇词/01"><span>开篇词 | 网络排查是工程师的必备能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/02.预习篇">02.预习篇</a><ul><li><a href="/blog-base/网络排查案例课/02.预习篇/01"><span>01 | 网络模型和工具：网络为什么要分层？</span></a></li><li><a href="/blog-base/网络排查案例课/02.预习篇/02"><span>02 | 抓包分析技术初探：你会用tcpdump和Wireshark吗？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇">03.实战一TCP真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/01"><span>03 | 握手：TCP连接都是用TCP协议沟通的吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/02"><span>04 | 挥手：Nginx日志报connection reset by peer是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/03"><span>05 | 定位防火墙（一）：传输层的对比分析</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04"><span>答疑（一）| 第1~5讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/05"><span>06 | 定位防火墙（二）：网络层的精确打击</span></a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06"><span>07 | 保活机制：心跳包异常导致应用重启？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/07"><span>08 | 分段：MTU引发的血案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08"><span>09 | 长肥管道：为何文件传输速度这么慢？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/09"><span>10 | 窗口：TCP Window Full会影响传输效率吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/10"><span>答疑（二）| 第6~10讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/11"><span>11 | 拥塞：TCP是如何探测到拥塞的？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/12"><span>12 | 重传的认识：重传到底是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/13"><span>13 | 重传的再认识：没有任何丢包却也一直重传？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/14"><span>14 | 安全：用Wireshark把DDoS攻击照出原形</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送">04.春节特别放送</a><ul><li><a href="/blog-base/网络排查案例课/04.春节特别放送/01"><span>春节特别放送（一）| 书单推荐</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/02"><span>春节特别放送（二）| 聊聊能力陷阱和终身学习</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/03"><span>春节特别放送（三）| 我的学习资料和工具</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/04"><span>春节特别放送（四）| 测一测你的网络排查能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇">05.实战二应用层真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/01"><span>15 | Nginx的499状态码是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/02"><span>答疑（三）| 第11~15讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/03"><span>16 | 服务器为什么回复HTTP 400？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/04"><span>17 | 为什么前端页面里多选一个城市就报错？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/05"><span>18 | 偶发性问题如何排查？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/06"><span>19 | TLS的各种特性：TLS握手为什么会失败？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/07"><span>20 | TLS加解密：如何解密HTTPS流量？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/08"><span>答疑（四）| 第16~20讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/09"><span>21 | 为什么用了负载均衡更加不均衡？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/10"><span>22 | 为什么压力测试TPS总是上不去？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇">06.实战三不用抓包就能做的网络排查篇</a><ul><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/01"><span>23 | 路径排查：没有网络设备权限要如何做排查？</span></a></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/02"><span>24 | 丢包：如何确定丢包的存在及其程度？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐">07.不定期加餐</a><ul><li><a href="/blog-base/网络排查案例课/07.不定期加餐/01"><span>不定期加餐（一） | 八仙过海，各显神通：透传真实源IP的各种方法</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/02"><span>用户故事 | 小S：学习是人生路上生生不息的活泉</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/03"><span>用户故事 | 王未：网络排查能力是一名合格运维工程师的必备技能</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/08.总结篇">08.总结篇</a><ul><li><a href="/blog-base/网络排查案例课/08.总结篇/01"><span>25 | 抓包分析的回顾、拾遗，和提高</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/02"><span>结束语 | 珍惜握手，难说再见</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/03"><span>结课测试 | “网络排查案例课”100分试卷等你来挑战！</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/summary">网络排查案例课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="TCP长连接为何总中断？" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#tcp长连接为何总中断"><span>TCP长连接为何总中断？</span></a></li><li title="应用概况" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#应用概况"><span>应用概况</span></a></li><li title="排查思路" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#排查思路"><span>排查思路</span></a></li><li title="结论：排除网络，追查代码" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#结论排除网络追查代码"><span>结论：排除网络，追查代码</span></a></li><li title="理解心跳机制的原理" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#理解心跳机制的原理"><span>理解心跳机制的原理</span></a></li><li title="TCP Keep-alive" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#tcp-keep-alive"><span>TCP Keep-alive</span></a></li><li title="HTTP Keep-alive" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#http-keep-alive"><span>HTTP Keep-alive</span></a></li><li title="小结" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#小结"><span>小结</span></a></li><li title="思考题" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#思考题"><span>思考题</span></a></li><li title="附录" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#附录"><span>附录</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="07--保活机制心跳包异常导致应用重启"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#07--保活机制心跳包异常导致应用重启"><span class="icon icon-link"></span></a>07 | 保活机制：心跳包异常导致应用重启？</h1><p>你好，我是胜辉。这节课，咱们来聊聊TCP的保活机制。</p><p>以前的电视剧里经常会有这样的剧情：女主因为车祸失去了记忆，男主一边摇着女主的肩膀，一边痛苦地问道：“还记得我吗？我是欧巴啊！”可是女主已经对此毫无记忆，迷茫地反问道：“欧巴是谁？”</p><p>类似地，TCP其实也需要一种机制，让双方能保持这种“记忆”。Keep-alive这个词，你可能也听说过。特别是当遇到一些连接方面的报错的时候，可能有人会告诉你“嗯，你需要设置下Keep-alive”，然后问题确实解决了。</p><p>不过，你有没有深入思考过这样几个问题呢：</p><ul><li>Keep-alive跟长连接是什么关系？</li><li>它是应用层代码独立实现，还是依赖操作系统的TCP协议栈去实现？</li><li>在HTTP层面也有一个Keep-alive的概念，它跟TCP的Keep-alive，是同一个东西吗？</li></ul><p>如果你对这几个问题的答案还不清楚，那么这节课，我就来帮助你厘清这些概念。以后你再遇到长连接失效、被重置、异常关闭等问题的时候，就知道如何通过抓包分析，解读出心跳包相关的信息，然后运用Keep-alive的相关知识点，去真正解决前面说的一系列问题。</p><p>好，按惯例，我们还是从案例说起。</p><h2 id="tcp长连接为何总中断"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#tcp长连接为何总中断"><span class="icon icon-link"></span></a>TCP长连接为何总中断？</h2><p>当时我在云计算公司就职，有个客户的应用基于TCP长连接，但长连接经常中断，引起了应用方面的大量报错。由于客户的业务是支付相关的，对实时性和安全性要求很高，这类报错就产生了较大的负面影响，所以急需解决。</p><h3 id="应用概况"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#应用概况"><span class="icon icon-link"></span></a>应用概况</h3><p>这个应用的架构比较简单：客户在云平台上部署了多台云主机，其中一台云主机专门做加解密，称之为加密服务器。另外几台云主机作为这台加密服务器的客户端，跟这台加密服务器保持TCP长连接。这些客户端会不时地跟加密服务器进行通信，完成加密操作。每45秒，客户端还会发送一次心跳包，这有两个作用：</p><ul><li>维持这个长连接不被中断，即<strong>心跳保活</strong>，让长连接在两端保持下去；</li><li>探测加密服务器的可用性，即<strong>健康检查</strong>，一旦服务不可用，客户端就要去掉这个失效的连接。</li></ul><p>就像下图这样：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimageac49ac7d92d0d0a77e425byy00ef52b0a149.97ff81fb.jpg" alt=""/></p><p>如果加密服务器能在<strong>1秒内</strong>对心跳包进行回复，那么客户端就认为服务端正常可用，后续的数据交互（即加密请求）将继续在这条长连接上进行。而如果服务端未能在1秒内回复，那么客户端会认为该长连接已经中断，于是重启应用，发起一条新的长连接，并在日志中记录一次报错。</p><p>用类Python语法来描述，大体是这样的：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">while true:</span></div><div class="token-line"><span class="token plain">        sleep(45)</span></div><div class="token-line"><span class="token plain">        if Keep_alive_probe() is true:</span></div><div class="token-line"><span class="token plain">            continue</span></div><div class="token-line"><span class="token plain">        else:</span></div><div class="token-line"><span class="token plain">            restart()</span></div><div class="token-line"><span class="token plain">            log_error()</span></div></pre></div><h3 id="排查思路"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#排查思路"><span class="icon icon-link"></span></a>排查思路</h3><p>整体的排查思路跟<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/477510">网络分层模型<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>有点类似，逐层往下。我们需要先从应用层查找原因，然后是操作系统层面，最后是网络层分析。排查的顺序就是这样的：</p><blockquote><p><strong>应用层代码 -&gt; 操作系统的时间配置 -&gt; 网络的抓包分析</strong></p></blockquote><p>首先，客户自查了应用，没有发现可疑代码，并且尝试过重新部署代码、重装系统、更换IP等，但都未奏效。</p><p>那么，会不会是时间服务（ntp）的问题呢？我们检查了两侧机器的ntpd服务的状态，都是正常的。对比了两端机器的实际时间，也没有发现明显的误差。于是这个可能性也被排除了。</p><p>然后就需要排查网络了。我们在一台客户端上启动了抓包程序tcpdump，过滤条件是对端加密服务器的IP和端口。抓多久呢？因为问题大约十几分钟出现一次，那么按照这个频率，我们设定抓包时长为半个小时，得到了抓包文件。这样就能覆盖到一到两次的错误了。</p><blockquote><p>补充：抓包示例文件已经上传至<a target="_blank" rel="noopener noreferrer" href="https://gitee.com/steelvictor/network-analysis/blob/master/07/heartbeat.pcap">Gitee<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，建议用Wireshark打开文件，结合文稿学习。</p></blockquote><p>因此，通过检查应用日志，我们发现在抓包时间段内，应用日志又记下了两次报错，比如下面这个：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage848984d35533cb2e21e39f5c06504dcdb689.d54a9fbd.png" alt="图片"/></p><p>从日志上看，17:08:02这个时间点发生了一次报错，17:08:10发生了一次程序的重启。</p><p>有了应用层的信息，接下来，我们就需要在抓包文件中，<strong>找到传输层和网络层的信息来与应用层信息对应</strong>，这样排查工作才能继续推进。</p><p>但是日志记录的时间戳粒度太粗了，只精确到了秒级，而网络报文在Wireshark中都是微秒级的，一秒内可能会有成百上千个报文。所以，仅凭精确到秒的一个时间戳，还不足以让我们在几十个报文中，精确地找到对应的报文。这个时候，我们需要调整一下抓包文件分析工作的切入点。</p><p>一个常规的做法是，<strong>跳过案例本身的问题特殊性不谈，先从宏观上把握一下排查思路</strong>。也就是先不纠结于根据日志时间来寻找报文的难题，而是先看Expert Information，找一找有没有比较可疑的报文。打开Expert Information窗口，如下：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage5873587e830687d8b9786f09dffe8fba7773.db7cb6cf.png" alt="图片"/></p><p>可见，有80个Error级别的Malformed Packet（格式错误）报文和2个RST报文，都很可疑。</p><p>我们先看这80个Malformed Packet报文，这传递了什么信息呢？在Protocol栏显示SIGCOMP，说明Wireshark认为这80个报文是SIGCOMP协议的（SIP的信令压缩协议）。不过，客户的应用不是SIP相关的，显然这些报文应该是被Wiresharek误会了。</p><blockquote><p>在这里，我也给你一个小小的<strong>提醒</strong>：毕竟只有被公开广泛支持的数据格式和协议才能在Wireshark中正确展示，所以如果你看到类似这种Malformed Packet的时候，还是要统筹考虑当前案例的实际情况，未必Malformed报文就真的是格式错误，也可能只是Wireshark不了解某种“方言”而已。</p></blockquote><p>让我们看看这些报文究竟是什么。点开Error，选中一个报文。比如我这里选择37号报文：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage07fd0760eb16f56ec70837ab52e27894affd.45b92708.png" alt="图片"/></p><p>随后光标会自动定位到37号报文这里：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimageb551b50d75ae1b923d05a6b5997067416751.40b144ef.png" alt="图片"/></p><p>然后选了另外几个Malformed Packet，发现它们都是成对出现的。它们还有一个特征是：</p><ul><li>前一个报文的TCP载荷数据是01（十六进制）；</li><li>后一个报文的TCP载荷数据是41（十六进制）。</li></ul><p>这就像是某种“联动”机制了，会不会就是心跳报文呢？你注意下TCP Seglen这一栏（这是我添加的表示TCP载荷长度的列），有没有发现这类报文的长度都是1 ？我们就以 <code>tcp.len eq 1</code> 为过滤器，过滤出报文：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage9e919e44b98d20161159yyceabc3a11cfc91.f6a10598.png" alt="图片"/></p><p>可见，37和38是0秒发生的，76和77是45秒后发生的，然后98和154以及后面每一对报文，也都符合45秒间隔的规律，正好跟客户程序的<strong>45秒</strong>心跳包机制对上了。我们可以确认这些报文就是<strong>心跳报文</strong>了！更确切地说，每次成对出现的两个报文中：</p><ul><li>前一个是心跳探测包，它的TCP载荷数据为01（十六进制）；</li><li>后一个是心跳回复包，它的TCP载荷数据为41（十六进制）。</li></ul><p>**这是第一个比较明显的进展。**也就是说，我们已经可以找到应用层的心跳包在网络层的展示形式了，这对于后续的排查非常有帮助。</p><p>不过，也不要忘了，我们是来排查“心跳包失败导致连接中断”的问题的，现在只是找到了心跳包的特征，还需要找到真正的跟日志报错相关的报文，而这个报文是跟“连接中断”现象有关的。</p><p>那么会是什么样的报文呢？其实，我们在第4讲就研究过<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/480068">TCP挥手<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。你应该还记得，TCP的连接断开，无非跟两种报文有关：<strong>FIN和RST</strong>。</p><p>我们先尝试寻找FIN报文。输入过滤器：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.flags.fin eq 1</span></div></pre></div><p>结果发现什么报文都没有出来。可见，这次抓包里，连接的断开并不是用FIN完成的。</p><p><img src="data:image/png;base64,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x47OrgoA4AYV6UvQtm1brV27Vjt27ChxZrvdrsjISD3//PPq3LmzJk6cqDNnzji7DeVq+/btjm9jv/nmG40dO1Zz587VY489pt69eys2NlYzZsxQhw4d9NRTT2nLli2OZc+ePatJkyapc+fO6tu3r1avXu3s5jid1WpVenq67rnnHse0oKAgLVq0SP7+/srLy1OvXr20fPlyPfXUU5o0aZIk6fvvv9fQoUPVvn179evXT9u3by+xfFdXV/Xs2VN+fn6OALBjxw4NGTJE7du315AhQ7Rt2zbH/NOnT9e8efM0ePBgtW3bVjExMXrzzTdls9nUq1cvrVq16qa239XVVa1atVJERISOHj2qnTt3SpJiYmLUt29ftW/fXqNHj1ZcXJwkadasWdqwYYO2bdumXr166eTJk8XKrFmzpvr166e8vDwdPny41PO0pO1rZB03Y99KpZ8TNptNc+bMUbdu3dStWzd99tlnGjhwoH744Yebug/K6vDhw/r55581bdo0ValSRdKlrmKTJk1SQECAkpKSStzPVx6Hlzt79qxMJpP8/Pwc0wYMGKC33nrLcaez8Ljt0KGDRowYoYMHDzrmPXHihEaPHq327dvrpZde0po1a9S7d+8S63+1cgqPhTVr1qhPnz7q2rWrwsPDlZOTU+ZtNH36dC1evFgjRoxQx44dNXHiRB09elQ5OTnq1auX0tPTFR4eriFDhjja/9prr6lz58567rnn9N5776mgoMCp+xkAYEyR8PDoo4+qR48emjVrltLS0orNvGTJEkVHR2v48OGaN2+esrOzNWbMGF28eNHZ7Sg3ubm5SklJkSTl5ORo9+7dcnV1VXh4uGrVqqWRI0fK3d1dCxcuVPPmzTV79mzZ7XbZbDaNHTtWNptNCxYsUL9+/RQZGam7/dG4rq6u6tChgxYuXKjp06dr586dysvL03333ae6deuqoKBAZ86c0VdffaVXX31VI0eO1OHDh/X666+rZcuWioyM1IMPPqhJkyZd9SI3Ly9PaWlp8vLy0qFDhzR58mQFBwdr0aJFat26td544w3HBdT58+cVHR2tzp07a/HixQoJCdHw4cNlsVgUERGhrl27lst28Pf3V4MGDXTo0CFduHBBoaGheuaZZ7Rq1So1atRIc+bMUUFBgV5++WU98sgjCg4OVkREhOrVq1dieYUXsF5eXqWepyVtX6PruNF9e61z4v3339fmzZs1fvx4zZw5Uxs3btTRo0cd4wic5ejRo6pevXqxcV/16tXTvHnzio0TK3T5cXilNm3aqFKlSho4cKCWLl2qI0eOyMPDQyEhIXJzc9ORI0f0xhtvqH379lqyZIn8/f01YcIEpaeny2q16tVXX5Xdbtc//vEP9e/fX4sXL9bp06eLrae0cgqPhbVr1+r111/X2LFjtW7dOn377bdl3kbnz5/XqlWr1L17d82bN0/p6emKioqSm5ubIiIi5OnpqQEDBig0NFQ2m02jR4/WhQsXNHfuXI0aNUpffvmlFi1a5NT9DAAwpti98XHjxmnfvn2aNWuW5syZU+Szr7/+WoMGDVKnTp0kSdOmTVO3bt30yy+/KDAw0NltuSUqVaqkUaNGyWw2q0+fPoqNjdXo0aPl5uamF154Qd98843S09OVmpqq48eP65133lGVKlVUr149tWvXTtu3b7+urjR/JqGhoQoJCdHq1av11Vdfyc3NTS+++KIGDRrkmGfMmDFq06aNpEsXlY0bN9bIkSMlSc2bN1fLli1VoUIFx/wHDhyQxWJRWlqaYmJiZDKZ1KlTJ23YsEFNmzbV8OHDJUnNmjXT3r17tW3bNkdf9SeeeEJ9+vRxlFV48VzeDwmoX7++EhMTJUkmk0lnz56Vh4eHRo8e7Zindu3aqlKlisxmc7H6bNq0SW5ubvr555+1efNm/eUvf5Gfn1+p52nhXYHLt6+kq67jZu7bX3/9tdRzYuvWrRo4cKCja0toaGiR/eIsycnJ8vb2NjTv1Y7DK7m5uemTTz7RsmXLFB0draVLl8rPz09jx45VmzZt9O233yowMNAxnmDIkCFav3694uLi5OXlpaSkJC1ZskQ1atSQJJ0+fVpRUVHF1lNaOa1bt5YkDRs2TPfff78kadu2bdq5c6e6dOlS5u3UsWNHR9ju06ePwsLCZLfbFRAQIIvFIm9vb/n6+urYsWOKj4/X/PnzVbt2bUlSSkqKPv30U40YMcKZuxoAYECx8ODh4aFp06Zp6NChWrt2rWN6fn6+EhMTi1xc1KhRQ5UrV1Z8fPxdEx6qVq3qeHKMm5ubLBaLo8964SBFu93ueHrLwIEDHcva7XY1adLE2U1wOovF4uiacvbsWa1Zs0YffPCBgoKCHP2/Cy+KpEtdNK68qH3kkUeK/Lx3717Fx8fLbDarWbNmmjx5su65554Slw0ICNCvv/7q+Pnydd1K8fHxevzxx1WlShVNmTJFS5cu1UcffaSmTZtq8ODBateuXanLr127VhaLRZ6ennr66af10ksvXfM8LQwP5dXm0vZtVlaWpJLPifz8fCUnJxd52pCfn99t0fff399f69evNzTv1Y7DktSsWVMTJ07UxIkTFRcXp0WLFmnq1Klav3694uPjdfDgwSJPTHJxcVFSUpJycnLk4eFRZB9e3v3pcqWVUxgeCi/gJcnb2/u6u61dWU5+fr5sNpssFkuR+U6cOCEPD48i8/v7+ys5OVlWq/W6xuwAAG6dEv8yN2/eXEOGDFF4eLhq166tBg0aqEKFCqpTp46Sk5Md82VkZCgjI0O+vr7Obsdtp379+jKbzYqOjlblypWdXZ3bRkJCgjZu3Kh+/frJzc3N0fVrx44d2r17tyM8XM7Pz08HDhwoMi0+Pl7Vq1dX1apVJV3qL17SU198fHx05MiRItOSk5PVsGFDp26HH374QadOnVLz5s0lSU8++aSefPJJJScna+XKlXrjjTe0fv36IoH0Su+99548PT2LTb/e87SkdZTFtfbtE088Ueo5UatWrSL1TklJuS26RAYGBiojI0N79uzRAw884JielJSkyMhIjRw50nG36mrH4ZW2bdumjIwMde/eXZJ07733avz48erbt68OHz6s+vXrq3Xr1po/f36xZQvHEiQnJzvW+/PPP5e4ntLKuZ6xDTeDj4+PcnJylJ6e7niqVXJysmrVqkVwAIA7wFUfvv5f//Vfatq0aZFvoR555BEtW7ZMBw8e1G+//aZ3331XtWrVUpMmTZSenq6wsLCr/hG72zRu3Fg1a9bUvHnzdO7cOcXHx2vw4MFatmyZs6vmVF5eXlq5cqXeeecdpaSkKC8vT5s2bVJiYqJatmxZ4jJt27bVwYMH9cknn+jcuXOKjo5W3759SxyoWtKysbGx+uKLLxzL/uc//yn1yT81atSQzWbTjh07blp/+5SUFMXHx2vv3r1atmyZJk6cqC5duujBBx/UwYMH9dxzz+nAgQPy9vZWYGCgbDab42K+Ro0aOnz4sJKTkw1d4Jd2npbW5rKs43r27bXOiYceekgffvihfvrpJyUmJuqdd965Kdv+RjVt2lSPPvqopk6dqh07digzM9MxluDEiROqW7dumcvMzc3V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" alt="图片"/></p><p>接着就是寻找RST报文。其实，在Expert Information里面，就有2个RST报文，我们可以直接从那里入手。当然，用过滤器也同样方便，输入：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.flags.reset eq 1</span></div></pre></div><p>我们能找到2个RST报文：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage25e325f575477b2af6be54f51340a39040e3.1acfb685.png" alt="图片"/></p><p>我们选中575号报文，然后Follow -&gt; TCP Stream，得到了这个RST所在的TCP流的全部报文：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage1y381yyb053e46e3dcf4702bdfa2df015f38.e10ca0c9.png" alt="图片"/></p><p>报文很多，上图显示的只是一部分报文。我往前翻阅了更前面的报文，也能看到很多相对长的时间间隔，有17秒、39秒、11秒的，但也没有什么规律。这时候，我们就需要结合前面刚分析到的一些信息，要不然就要在报文的海洋里迷失方向了。</p><p>我们通过前面的分析发现，心跳探测包的报文数据是01，心跳回复包的报文数据是41。所以，让我们再次借助强大的过滤器。在 <code>tcp.stream eq 0</code> 后面添加 <code>and tcp.payload eq 01</code>，即整体过滤器变为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.stream eq 0 and tcp.payload eq 01</span></div></pre></div><p>这样就过滤出了这个TCP流里面，<strong>所有的心跳探测包</strong>：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage6c0c6c86e426b76f84dc529a66d05169cd0c.8b006187.png" alt="图片"/></p><p>可见，这些心跳探测包也是很明显遵循了45秒间隔的规律。不过，等一下，为什么572号心跳探测包跟它的上一次心跳探测，间隔的时间是<strong>58秒</strong>，而不是45秒呢？</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimagefe18fed696dbb35675c0fb989a9728bf7218.4d16ec5a.png" alt="图片"/></p><p>**这很反常，也是第二个很重要的发现。**要知道，这45秒的机制是在代码里实现的，照理说不可能出现13秒这么大的误差。现在，我们把 <code>tcp.payload eq 01</code> 这个条件去掉，回到这个TCP流的完整报文区域来综合分析：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimagef743f760066db14b0f950d3c71329ee22043.b8aaa1e3.png" alt="图片"/></p><p>我来给你解读一下：</p><ul><li>572号报文（客户端发出）是心跳探测包；</li><li>573号报文（服务端发出）是心跳回复包；</li><li>574号报文（客户端发出）是客户端对573号报文的确认；</li><li>575号报文（客户端发出）是一个RST报文，它跟客户端日志报错有直接的关系。</li></ul><p>以上4个报文之间几乎没有时间上的停顿。这里，你可能会有个小疑问：为什么572号报文跟上一个报文的间隔是17秒而不是45秒呢？其实，这是<strong>Time列的类型</strong>导致的，我这里用的是Delta time displayed类型，是跟前一个被显示的报文的间隔时间。</p><p>之前我们看到很多个整齐的45秒，是因为那个窗口里显示的报文，都是过滤过的心跳报文，跟这里<strong>显示的报文</strong>不同，所以显示的间隔时间也不同。Wireshark里的Time一列有多种配置可选，所以你一方面要理解这里面各种Time的区别，一方面自己做分析的时候，也可以根据实际需要，灵活选择Time类型。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage60106020ec054ae4fc6a79062fe025fde810.dbd7c749.png" alt="图片"/></p><p>考虑到这里的问题就是跟心跳包和挥手包直接相关，排除掉无关报文，可以让我们的分析思路也变得更加清晰。所以，我们再一次调整过滤器，改为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.stream eq 0 and (tcp.len == 1 or tcp.flags.reset == 1)</span></div></pre></div><p>就得到这个TCP流里面的心跳包和挥手包：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage2dec2df9da0f4fc2a4cfbda7752e38de98ec.da98e301.png" alt="图片"/></p><p>我们最后再确认一下时间戳。这个隔了58秒才发出的心跳包，发送的时间是在17:08:10：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage38c938ced831f878b7b94fb4d28af42e1cc9.7330dac7.png" alt="图片"/></p><p>跟日志中restart时间一致：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage7cf37c9bbea46yyd3641448e2d502b8acff3.e43397ba.png" alt="图片"/></p><p>现在，事实已经很清楚了：客户端在连接被断开之前的心跳探测包，并没有遵循客户声称的“每隔45秒”，而是很意外地隔了58秒。我们结合程序逻辑，已经可以推断出真实的状况了。看示意图：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimagef07ef03e54e7cb407456f4e324b85c8d7e7e.6325b57c.jpg" alt=""/></p><h3 id="结论排除网络追查代码"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#结论排除网络追查代码"><span class="icon icon-link"></span></a>结论：排除网络，追查代码</h3><p>现在，我们已经清楚了这个报错的原因：客户端程序出了一个Bug，某一次心跳探测包发出的时候是在上一次心跳的58秒以后（也就是相对正常情况，迟了13秒）。那么，服务端虽然立即发送了心跳回复包，但也一样是在58秒以后了。程序的逻辑非常简单粗暴：一旦心跳回复包的到达时间超过了第46秒（也就是45秒+1秒超时），就认为是心跳探测失败。</p><p>**为什么探测包本身会比预定的时间晚了13秒才发出呢？**根据这个很明确的信息，客户再次检查了应用代码，终于定位到了出问题的代码段。修复代码后，问题随之解决。</p><p>补充一下，在这个案例中，<strong>异常时的心跳包探测和回复的耗时本身是正常的</strong>。我们可以看到包号572是客户端发出的心跳探测包，包号573是服务端发出的心跳回复包。两者之间，间隔只有0.000370秒，即0.37毫秒，完全是同机房内网时延的正常水平。</p><h2 id="理解心跳机制的原理"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#理解心跳机制的原理"><span class="icon icon-link"></span></a>理解心跳机制的原理</h2><p>显然，这个案例是关于应用层自己实现的心跳机制的，有一定的特殊性。但在机制上，也体现了心跳包的一些特点，比如：</p><ul><li>定时发送心跳探测包；</li><li>对于心跳回复包有超时限制。</li></ul><p>而从更普适的尺度上来看，其实TCP本身提供的Keep-alive机制更为安全易用。</p><p>一般来说，对于操作系统已经实现的特性，我们最好<strong>直接去利用，而不是自己创造一个类似的轮子</strong>。这好比你想基于UDP，在应用层实现类似TCP的种种传输保障机制，也不是不可以，但实现起来会相当复杂（参考<a target="_blank" rel="noopener noreferrer" href="https://devopedia.org/quic">QUIC协议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。TCP心跳机制看似简单，但从上面这个案例来看，稍有不慎，还是很容易发生错误的。</p><h3 id="tcp-keep-alive"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#tcp-keep-alive"><span class="icon icon-link"></span></a>TCP Keep-alive</h3><p>那么TCP自身的Keep-alive，究竟是怎样的一个存在呢？</p><p>其实，如果不做显式的配置，默认创建出来的TCP Socket是不启用Keep-alive的，也就是都不会发送心跳包。不过，大部分应用程序已经在代码里启用了Keep-alive，所以你平时不太会遇到连接失效的问题。比如我稍后要演示的一个含心跳包的抓包文件，抓取的就是Chrome浏览器的流量，里面就有很多心跳包，因为Chrome浏览器启用了TCP心跳保活机制。</p><p>要打开这个TCP Keep-alive特性，你需要使用setsockopt()系统调用，对已经创建的Socket进行配置，启用Keep-alive。具体的调用方法，你可以参考<strong>man setsockopt</strong>。</p><p>在Linux操作系统层级，也有三个跟Keep-alive有关的全局配置项。</p><ul><li><strong>间隔时间</strong>：net.ipv4.tcp_keepalive_time，其值默认为7200（秒），也就是2个小时。</li><li><strong>最大探测次数</strong>：net.ipv4.tcp_keepalive_probes，在探测无响应的情况下，可以发送的最多连续探测次数，其默认值为9（次）。</li><li><strong>最长间隔</strong>：net.ipv4.tcp_keepalive_intvl，在探测无响应的情况下，连续探测之间的最长间隔，其值默认为75（秒）。</li></ul><blockquote><p>补充：你可以在Linux系统里面，执行<strong>man tcp</strong>，查看内核对TCP协议栈的详细文档。这里我摘录一下关于Keep-alive的部分：<br/></p><ul><li>tcp_keepalive_intvl (integer; default: 75; since Linux 2.4)</li></ul><p> <br/>The number of seconds between TCP keep-alive probes.<br/></p><ul><li>tcp_keepalive_probes (integer; default: 9; since Linux 2.2)</li></ul><p> <br/>The  maximum number of TCP keep-alive probes to send before giving up and killing the connection if no response is obtained from the other end.<br/></p><ul><li>tcp_keepalive_time (integer; default: 7200; since Linux 2.2)</li></ul><p> <br/>The number of seconds a connection needs to be idle before TCP  begins  sending  out  keep-alive probes.   Keep-alives are sent only when the SO_KEEPALIVE socket option is enabled.  The default value is 7200 seconds (2 hours).  An idle connection is terminated after approximately an  additional 11 minutes (9 probes an interval of 75 seconds apart) when keep-alive is enabled.</p></blockquote><p>如果我们连接启用了Keep-alive，但没有设定自定义的数值，那么就会使用上面这些默认值，即：当连接闲置（没有数据交互）达到7200秒（2小时）时发送心跳包，每次心跳包超时时间为75秒，最多重试9次。</p><p>这样的话，对于一个已经失效的TCP连接，最大需要7200+75*9=7875秒（约等于2小时11分钟）才能探测到。</p><p>毫无疑问，这个时间是相当长的。不过结合时代背景，这个其实也可以理解：TCP Keep-alive被设计的时候是八十年代，当时因特网还很初级，所以设计者们并不想让心跳包占据太多的网络资源。从而，就有了这么一个感知时间很长的心跳机制。关于TCP Keep-alive的一些更多信息在<a target="_blank" rel="noopener noreferrer" href="https://datatracker.ietf.org/doc/html/rfc1122#page-101">RFC1122<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里，你有兴趣的话可以去研究一下。</p><p>另外一个值得注意的地方，是Keep-alive报文本身的特点。在上面的案例中，这个特定的应用层代码设定的心跳包特征是这样的：</p><ul><li>心跳探测包，载荷为1个字节，其值为01。</li><li>心跳回复包，载荷也为1个字节，其值为41。</li></ul><p>但是TCP本身提供的Keep-alive报文特征就非常不同了。首先，它的序列号就很奇特，是上一个报文的序列号<strong>减1</strong>，载荷<strong>为0</strong>。回复的报文也同样特别，确认号为收到的序列号<strong>加1</strong>。而且，无论是探测包还是回复包，其载荷长度都<strong>为0</strong>。</p><p>文字描述不是很容易理解，我给你看一个实际的例子。这是某一次我用Chrome浏览器访问网站时做的抓包：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimageed1aed092d46acc5594db8ae276f927b2f1a.23b5aed1.png" alt="图片"/></p><p>上图的红色底色的多个报文，就是Wireshark识别出来的TCP心跳包。我也把需要关注的信息用红色方框标注出来了。</p><p>25号报文是离心跳包最近的一个常规报文，Wireshark告诉我们：它的下一个序列号（图中的NextSeq）是1578。也就是说，如果下一个是常规报文，那么这个常规报文的序列号就是1578。然后看同是这个客户端发出的报文27，这就是一个心跳包，它的序列号却是1577（也就是<strong>1578-1</strong>），载荷为0（Len=0）。对端对这个心跳包做了回应（包号28），确认号为1578（<strong>1577+1</strong>），载荷也为0。</p><p>我们再来看一下示意图：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage5b6c5b04d1eee64f3ea50185a479b55fc06c.5aef4ff2.jpg" alt=""/></p><p>要是你了解TCP握手和挥手阶段的确认号的话，你对这个+1机制是不是感觉很熟悉？可见，TCP认为心跳包也是十分重要的，它跟握手和挥手一样，都属于控制报文，它的确认号机制也体现了这一特点。</p><p>有趣的是，RFC1122里并没有规定心跳探测包的载荷一定是0，它也可以是1。只是从我有限的抓包经验来看，心跳包都是载荷为0的，看来这是比较常见的实现方式。</p><h3 id="http-keep-alive"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#http-keep-alive"><span class="icon icon-link"></span></a>HTTP Keep-alive</h3><p>那么我们也经常听到的HTTP Keep-alive，又是一个什么东西呢？难道是应用层实现的心跳保活机制？意味着HTTP也有心跳包这种东西吗？</p><p>其实没有那么复杂。**HTTP的Keep-alive，是用Connection这样一个HTTP header来实现的。**你应该知道，HTTP报文的header形式是Key: value。比如常见的header有：</p><ul><li>User-Agent: curl/7.68.0 （客户端发出）</li><li>Host: <a target="_blank" rel="noopener noreferrer" href="http://www.baidu.com/">www.baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> （客户端发出）</li><li>Content-Type: text/html （服务端发出）</li><li>Server: bfe/1.0.8.18 （服务端发出）</li></ul><p>而Keep-alive头部，就是这个形式：<strong>Connection: Keep-alive</strong>（注意这里有一个“-”符号）。</p><p>客户端和服务端都可以发送这个保活头部。表达的意思也跟外交人员的语言一样优雅专业：“我方真诚地希望，贵方能切实履行我们的协议，按照长连接待遇来处理本次连接，谢谢配合”。</p><p>你应该也知道，HTTP的版本有0.9、1.0、1.1、2.0。HTTP/0.9现在基本不再使用了，而HTTP/1.0占的流量比例也已经很低了（在公网上小于1%）。目前占主流的是HTTP/1.1和HTTP/2，而这两者都<strong>默认使用长连接</strong>。</p><p>那既然HTTP/1.1默认是长连接了，为什么还要有这个Connection头部呢？在我看来，这有两个原因。</p><ul><li><strong>协议兼容性</strong></li></ul><p>在HTTP/1.0版本中，默认用的是短连接。这导致了一个明显的问题：每次HTTP请求都需要创建一个新的TCP连接。随着因特网带宽和各类资源迅速增长，每次建立TCP连接的开销变成了主要矛盾。</p><p>为了克服这个不足，Connection: Keep-alive头部被扩充进了HTTP/1.0，用来显式地声明这应该是一次长连接。当然，从HTTP/1.1开始，长连接已经是默认设置了，但为了兼容1.0版本的HTTP请求，Connection这个头部在HTTP/1.1里得到了保留。</p><ul><li><strong>关闭连接的现实需求</strong></li></ul><p>即使在HTTP/1.1里，也并非所有的长连接都需要永久维持。有时候任意一方想要关闭这个连接，又想用一种“优雅”（graceful）的方式，那么就可以用 <strong>Connection: Close</strong> 这个头部来达到“通知对端关闭连接”的目的，体面而有效。另外，在HTTP/2里，连接关闭是通过另外的机制实现的，与Connection头部无关。</p><p>这个Connection头部看似简单，其实有时候也能起到很大的作用。在eBay，我们每年有大量的流量迁移的工作。其中，这个Connection头部就在迁移的<strong>平滑度和收敛速度</strong>上，起到了很关键的作用。</p><p>具体来说，我们在新老两个VIP之间迁移流量，用的是名称解析（基于DNS/GSLB）的返回值的比例，来控制真实的HTTP流量比例，这就可以逐步从新老比例为1:99，到50:50，最后到100:0也就是全部到新VIP。</p><p>但是这样会有这么个问题：因为流量基本都是HTTP/1.1（即默认是长连接），客户端依然坚持使用着老的VIP，造成DNS/GSLB的比值调整没有起到应有的效果，真正观察到的流量经常跟DNS/GSLB的设置值相差甚远，或者说<strong>有很强的滞后性</strong>。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimagee2fee2864876efec290dc58ebf62393d76fe.1bfeb95c.jpg" alt=""/></p><p>从上图中可以看到，客户端在查询GSLB（相当于智能DNS）的时候，拿到的新老IP的比例为2:2，那么访问量应该也是符合这个比例。但是因为长连接的存在，这些拥有长连接的客户端连问都不会去问GSLB，而是会继续往老的连接（也就是连着老VIP的连接）上发送流量，那么我们迁移流量的工作，就受到影响了。</p><p>为了解决这个问题，我们当然可以选择等待（比如几小时甚至几天）它自然收敛，但其实我们找到了更好的办法：在新老VIP上都添加了rewrite policy，使得每一定比例的HTTP响应里面，都带上Connection: Close这个头部。</p><p>客户端收到这个头部后，按照协议规定，它必须关闭这条长连接。在下一次HTTP请求的时候，客户端就会遵循“DNS解析-&gt;发起新连接-&gt;发送HTTP请求”这样的工作路径，于是新发起的连接数跟DNS解析数量基本对齐，也就达到了我们的目的。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimageb65cb608c91ef62f7b824cb8b3fa5935f65c.b3f3ff30.jpg" alt=""/></p><p>下图是在迁移尾声时候的流量趋势图。在这个阶段，老VIP已经从DNS/GSLB里禁用了。但原先不插入这种Connection: Close头部的话，总还是有很多请求在老的VIP上。在插入了Connection: Close头部后，老VIP上的流量几乎立刻停止，可谓立竿见影。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage6452641ebb1db456baebfcda566b35d4ff52.513ba219.png" alt="图片"/></p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#小结"><span class="icon icon-link"></span></a>小结</h2><p>这节课，我们通过一个奇特的案例，详细探究了一种应用层保活机制的Bug引发的报错。在这个排查过程中，<strong>Wireshark过滤器</strong>的使用，很大程度上帮助了这次排查。所以，这里我推荐你要熟悉以下这些过滤器，在你以后的网络排查工作中，应该能给到不少的帮助：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.len eq 长度</span></div><div class="token-line"><span class="token plain">    tcp.flags.fin eq 1</span></div><div class="token-line"><span class="token plain">    tcp.flags.reset eq 1</span></div><div class="token-line"><span class="token plain">    tcp.payload eq 数据</span></div></pre></div><p>抓包分析中，面对Wireshark里千奇百怪的报文，有时候也会遇到不知道从何下手的窘况，那么你可以<strong>直接查看Expert Information</strong>，从那里寻找线索也不失为一个有效的办法。</p><p>另外，在原理部分，我还给你介绍了TCP层面的Keep-alive和HTTP层面的Keep-alive的联系和区别。应该说，这确实是两个容易令人困惑的概念，不仅名称一样，作用也接近。通过这次讲解，希望能帮助你彻底理解这两个概念。</p><p>最后，我再给你梳理提炼一下这节课的关键知识点。</p><p>首先，对于TCP Keep-alive，你需要掌握：</p><ul><li>默认TCP连接并不启用Keep-alive，若要打开的话要<strong>显式地调用setsockopt()</strong>，来设置保活包的发送间隔、等待时间、重试个数等配置。在全局层面，Linux还默认有3个跟Keep-alive相关的内核配置项可以调整：tcp_Keepalive_time，tcp_Keepalive_probes，还有tcp_Keepalive_intvl。</li><li>TCP心跳包的特点是，它的序列号是<strong>上一个包的序列号-1</strong>，而心跳回复包的确认号是这个序列号-1+1（即还是这个序列号）。</li></ul><p>然后，对于HTTP Keep-alive的知识点，你需要理解：</p><ul><li>HTTP/1.0默认是短连接，HTTP/1.1和2默认是长连接。</li><li><strong>Connection: Keep-alive</strong> 在HTTP/1.0里，能起到维持长连接的作用，而在HTTP/1.1里面没有这个作用（因为默认就是长连接）。</li><li><strong>Connection: Close</strong> 在HTTP/1.1里，可以起到优雅关闭连接的作用。这个头部在流量调度场景下也很有用，能明显加快基于DNS/GSLB的流量调整的收敛速度。</li></ul><h2 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#思考题"><span class="icon icon-link"></span></a>思考题</h2><p>最后再给你留两道思考题：</p><ol><li><code>tcp.payload eq abc</code>，这个过滤器可以搜索到精确匹配“abc”字符串的报文。那么，如果是模糊匹配，比如只要**包含“abc”**的报文我都想搜到，这个过滤器又该如何写呢?</li><li>在工作中，你遇到过跟TCP Keep-alive相关的问题吗？你是怎么解决的呢？</li></ol><p>欢迎你把答案分享到留言区，我们一起进步成长。</p><h2 id="附录"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06#附录"><span class="icon icon-link"></span></a>附录</h2><p>抓包示例文件：<a target="_blank" rel="noopener noreferrer" href="https://gitee.com/steelvictor/network-analysis/tree/master/07">https://gitee.com/steelvictor/network-analysis/tree/master/07<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/网络排查案例课/03.实战一TCP真实案例揭秘篇/06.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 19:21:54</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-base/umi.js"></script>
  </body>
</html>
