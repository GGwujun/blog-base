<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-base/umi.css" />
    <script>
      window.routerBase = "/blog-base";
    </script>
    <script>
      window.publicPath = window.resourceBaseUrl || "/blog-base/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>答疑（一）| 第1~5讲思考题答案 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/网络排查案例课/03.实战一tcp真实案例揭秘篇/04" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></span><span>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></span><span>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></span><span>前端工程化</span><span>前端性能优化</span><span>移动端开发</span><span>软件测试</span><span>产品与用户体验</span><span>面试</span><span>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-base/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>计算机基础<ul><li><a href="/blog-base/编译原理之美">编译原理之美</a></li><li><a href="/blog-base/编译原理实战">编译原理实战</a></li><li><a href="/blog-base/深入浅出计算机组成原理">深入浅出计算机组成原理</a></li><li><a href="/blog-base/详解http">详解http</a></li><li><a href="/blog-base/计算机网络通关29讲">计算机网络通关29讲</a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/linux操作系统">linux操作系统</a></li><li><a href="/blog-base/linux内核技术实战课">linux内核技术实战课</a></li><li><a href="/blog-base/linux性能优化实战">linux性能优化实战</a></li><li><a href="/blog-base/程序员数学基础">程序员数学基础</a></li><li><a href="/blog-base/趣谈网络协议">趣谈网络协议</a></li><li><a href="/blog-base/操作系统实战">操作系统实战</a></li><li><a href="/blog-base/软件工程之美">软件工程之美</a></li><li><a href="/blog-base/sql必知必会">sql必知必会</a></li><li><a href="/blog-base/操作系统实战45讲">操作系统实战45讲</a></li><li><a href="/blog-base/网络编程实战">网络编程实战</a></li><li><a href="/blog-base/趣谈linux操作系统">趣谈linux操作系统</a></li></ul></li><li>算法<ul><li><a href="/blog-base/常用算法25讲">常用算法25讲</a></li><li><a href="/blog-base/数据结构与算法之美">数据结构与算法之美</a></li><li><a href="/blog-base/业务开发算法50讲">业务开发算法50讲</a></li><li><a href="/blog-base/动态规划面试宝典">动态规划面试宝典</a></li></ul></li><li>前端开发<ul><li><a href="/blog-base/正则表达式入门">正则表达式入门</a></li></ul></li><li>前端工程化</li><li>前端性能优化</li><li>移动端开发</li><li>软件测试</li><li>产品与用户体验</li><li>面试</li><li>杂谈<ul><li><a href="/blog-base/代码之丑">代码之丑</a></li><li><a href="/blog-base/代码精进之路">代码精进之路</a></li><li><a href="/blog-base/数据分析思维课">数据分析思维课</a></li><li><a href="/blog-base/朱涛kotlin编程第一课">朱涛kotlin编程第一课</a></li><li><a href="/blog-base/重学线性代数">重学线性代数</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-base/网络排查案例课">网络排查案例课</a></li><li><a href="/blog-base/网络排查案例课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-base/网络排查案例课/01.开篇词/01"><span>开篇词 | 网络排查是工程师的必备能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/02.预习篇">02.预习篇</a><ul><li><a href="/blog-base/网络排查案例课/02.预习篇/01"><span>01 | 网络模型和工具：网络为什么要分层？</span></a></li><li><a href="/blog-base/网络排查案例课/02.预习篇/02"><span>02 | 抓包分析技术初探：你会用tcpdump和Wireshark吗？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇">03.实战一TCP真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/01"><span>03 | 握手：TCP连接都是用TCP协议沟通的吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/02"><span>04 | 挥手：Nginx日志报connection reset by peer是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/03"><span>05 | 定位防火墙（一）：传输层的对比分析</span></a></li><li><a aria-current="page" class="active" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04"><span>答疑（一）| 第1~5讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/05"><span>06 | 定位防火墙（二）：网络层的精确打击</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/06"><span>07 | 保活机制：心跳包异常导致应用重启？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/07"><span>08 | 分段：MTU引发的血案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/08"><span>09 | 长肥管道：为何文件传输速度这么慢？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/09"><span>10 | 窗口：TCP Window Full会影响传输效率吗？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/10"><span>答疑（二）| 第6~10讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/11"><span>11 | 拥塞：TCP是如何探测到拥塞的？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/12"><span>12 | 重传的认识：重传到底是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/13"><span>13 | 重传的再认识：没有任何丢包却也一直重传？</span></a></li><li><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/14"><span>14 | 安全：用Wireshark把DDoS攻击照出原形</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送">04.春节特别放送</a><ul><li><a href="/blog-base/网络排查案例课/04.春节特别放送/01"><span>春节特别放送（一）| 书单推荐</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/02"><span>春节特别放送（二）| 聊聊能力陷阱和终身学习</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/03"><span>春节特别放送（三）| 我的学习资料和工具</span></a></li><li><a href="/blog-base/网络排查案例课/04.春节特别放送/04"><span>春节特别放送（四）| 测一测你的网络排查能力</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇">05.实战二应用层真实案例揭秘篇</a><ul><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/01"><span>15 | Nginx的499状态码是怎么回事？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/02"><span>答疑（三）| 第11~15讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/03"><span>16 | 服务器为什么回复HTTP 400？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/04"><span>17 | 为什么前端页面里多选一个城市就报错？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/05"><span>18 | 偶发性问题如何排查？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/06"><span>19 | TLS的各种特性：TLS握手为什么会失败？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/07"><span>20 | TLS加解密：如何解密HTTPS流量？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/08"><span>答疑（四）| 第16~20讲思考题答案</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/09"><span>21 | 为什么用了负载均衡更加不均衡？</span></a></li><li><a href="/blog-base/网络排查案例课/05.实战二应用层真实案例揭秘篇/10"><span>22 | 为什么压力测试TPS总是上不去？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇">06.实战三不用抓包就能做的网络排查篇</a><ul><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/01"><span>23 | 路径排查：没有网络设备权限要如何做排查？</span></a></li><li><a href="/blog-base/网络排查案例课/06.实战三不用抓包就能做的网络排查篇/02"><span>24 | 丢包：如何确定丢包的存在及其程度？</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐">07.不定期加餐</a><ul><li><a href="/blog-base/网络排查案例课/07.不定期加餐/01"><span>不定期加餐（一） | 八仙过海，各显神通：透传真实源IP的各种方法</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/02"><span>用户故事 | 小S：学习是人生路上生生不息的活泉</span></a></li><li><a href="/blog-base/网络排查案例课/07.不定期加餐/03"><span>用户故事 | 王未：网络排查能力是一名合格运维工程师的必备技能</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/08.总结篇">08.总结篇</a><ul><li><a href="/blog-base/网络排查案例课/08.总结篇/01"><span>25 | 抓包分析的回顾、拾遗，和提高</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/02"><span>结束语 | 珍惜握手，难说再见</span></a></li><li><a href="/blog-base/网络排查案例课/08.总结篇/03"><span>结课测试 | “网络排查案例课”100分试卷等你来挑战！</span></a></li></ul></li><li><a href="/blog-base/网络排查案例课/summary">网络排查案例课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="01讲的答疑" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#01讲的答疑"><span>01讲的答疑</span></a></li><li title="思考题" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题"><span>思考题</span></a></li><li title="答案" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案"><span>答案</span></a></li><li title="02讲的答疑" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#02讲的答疑"><span>02讲的答疑</span></a></li><li title="思考题" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-1"><span>思考题</span></a></li><li title="答案" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-1"><span>答案</span></a></li><li title="03讲的答疑" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#03讲的答疑"><span>03讲的答疑</span></a></li><li title="思考题" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-2"><span>思考题</span></a></li><li title="答案" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-2"><span>答案</span></a></li><li title="04讲的答疑" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#04讲的答疑"><span>04讲的答疑</span></a></li><li title="思考题" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-3"><span>思考题</span></a></li><li title="答案" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-3"><span>答案</span></a></li><li title="05讲的答疑" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#05讲的答疑"><span>05讲的答疑</span></a></li><li title="思考题" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-4"><span>思考题</span></a></li><li title="答案" data-depth="3"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-4"><span>答案</span></a></li><li title="小结" data-depth="2"><a href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#小结"><span>小结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="答疑一-第15讲思考题答案"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答疑一-第15讲思考题答案"><span class="icon icon-link"></span></a>答疑（一）| 第1~5讲思考题答案</h1><p>你好，我是胜辉。</p><p>不知不觉，咱们已经完成预习篇、实战一的TCP真实案例篇，还有实战二的应用层真实案例篇的学习了。一路走来，我自己完成了20多讲的备课，过程中是辛劳和满足相伴。当然你也很不容易，坚持学完20多讲，一共投入的时间也接近20个小时，这个过程本身就是一种小小的成就。</p><p>由于课程涉及的网络知识面还是比较广泛的，如果你还有不少没看懂的地方，也别着急，这是很正常的情况。就我自己来说，最初看那些TCP/IP概念的时候也是摸不到头脑，后来我就是反复看，从不同的资料、不同的案例来入手，才逐步建立起自己的理解。</p><p>正因为<strong>通过问题来理解概念</strong>是一种很好的学习方法，所以我在每节课的后面，都留有一两个思考题，希望可以促进思考。这些问题，有些比较容易，有些可能略有难度。所以我整理了答疑篇，一方面给出答案供你参考，一方面也正好把课程里没有覆盖到的细节给你展开一下，作为内容上的补充。总之，我希望通过这个答疑环节，能帮助你把看过的知识都真的消化掉，成为你自己知识体系的一部分。</p><h2 id="01讲的答疑"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#01讲的答疑"><span class="icon icon-link"></span></a>01讲的答疑</h2><h3 id="思考题"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题"><span class="icon icon-link"></span></a>思考题</h3><ol><li>traceroute默认是用UDP来做探测的，那这个又是基于什么原理呢？通和不通，我们会收到怎样的回复？</li><li>有时候运行telnet后命令就挂起，没有响应了，这说明了什么问题呢？</li></ol><h3 id="答案"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案"><span class="icon icon-link"></span></a>答案</h3><p>关于第一个问题，我看到很多同学的回答都已经很到位了，比如以**@webmin**同学的回答为例：</p><blockquote><p>traceroute使用UDP探测时，初始时把TTL设置为1，经过路由器时TTL会被减1，当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message）。源收到这个通知，就会把下一次发送的包的TTL在原来的基础加1，这样就可以多前进一步。探测时使用了一个大于30000的端口号去连接，随着TTL的增加端口也会加1，目地服务器在收到这个数据包的时候，会返回一个端口不可达的ICMP错误信息（ICMP Port Unreachable），当源地址收到ICMP Port Unreachable包时，会停止traceroute。</p></blockquote><p>在我的Ubuntu虚拟机上，traceroute使用的起始UDP目的端口是33434，然后每次探测的TTL加一的同时，UDP目的端口也加一，每次探测会发送3次探测报文。也就是下图这样：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage00b1004a31737f71e76c5c18f8a6152370b1.dd81d3f3.jpg" alt="图片"/></p><p>当时的traceroute命令行的输出是这样的：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">traceroute www.baidu.com</span></div><div class="token-line"><span class="token plain">    traceroute to www.a.shifen.com (180.101.49.11), 64 hops max</span></div><div class="token-line"><span class="token plain">      1   10.0.2.2  0.082ms  0.177ms  0.088ms</span></div><div class="token-line"><span class="token plain">      2   192.168.1.1  4.634ms  1.811ms  1.488ms</span></div><div class="token-line"><span class="token plain">      3   100.65.0.1  9.972ms  11.511ms  6.189ms</span></div><div class="token-line"><span class="token plain">      4   61.152.54.125  16.296ms  3.576ms  4.095ms</span></div><div class="token-line"><span class="token plain">      5   61.152.24.102  7.329ms  6.786ms  11.987ms</span></div><div class="token-line"><span class="token plain">      6   202.97.71.6  28.938ms  10.568ms  10.069ms</span></div><div class="token-line"><span class="token plain">      7   58.213.95.2  15.036ms  9.831ms  17.043ms</span></div><div class="token-line"><span class="token plain">      8   *  *  *</span></div><div class="token-line"><span class="token plain">      9   58.213.96.54  16.843ms  10.329ms  15.989ms</span></div><div class="token-line"><span class="token plain">     10   *  *  *</span></div><div class="token-line"><span class="token plain">     11   *  *  *</span></div><div class="token-line"><span class="token plain">     12   *  *  *</span></div><div class="token-line"><span class="token plain">     13   *  *  *</span></div><div class="token-line"><span class="token plain">     14   *  *  *</span></div><div class="token-line"><span class="token plain">     15   *  *  *</span></div><div class="token-line"><span class="token plain">     16   *  *  *</span></div></pre></div><p>这次traceroute没有停住，而是一直到64跳的限制后才停止（因为输出过长，我没有把全部的信息复制过来）。当然，一般实践中你看到连续六七个以上的<code>*</code>，基本就可以判定是目的端对UDP无响应，可以按下 Ctrl + C 终止了。</p><p>我把整个流程的实现原理，概括成了下面的示意图，希望能帮助你理解：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage471647d5afb17a8a478e3bc1e0700e09d116.b38ee631.jpg" alt=""/></p><p>然后，我们再用ICMP模式做一次traceroute，输出如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ traceroute -I www.baidu.com</span></div><div class="token-line"><span class="token plain">    traceroute to www.a.shifen.com (180.101.49.12), 64 hops max</span></div><div class="token-line"><span class="token plain">      1   10.0.2.2  0.105ms  0.229ms  0.173ms</span></div><div class="token-line"><span class="token plain">      2   192.168.1.1  8.972ms  1.725ms  1.326ms</span></div><div class="token-line"><span class="token plain">      3   100.65.0.1  9.850ms  7.893ms  7.311ms</span></div><div class="token-line"><span class="token plain">      4   *  *  61.152.53.149  5.579ms</span></div><div class="token-line"><span class="token plain">      5   *  61.152.25.230  20.238ms  5.204ms</span></div><div class="token-line"><span class="token plain">      6   *  *  *</span></div><div class="token-line"><span class="token plain">      7   *  58.213.94.114  21.249ms  *</span></div><div class="token-line"><span class="token plain">      8   58.213.94.126  13.869ms  *  *</span></div><div class="token-line"><span class="token plain">      9   58.213.96.54  11.736ms  10.094ms  10.644ms</span></div><div class="token-line"><span class="token plain">     10   *  *  *</span></div><div class="token-line"><span class="token plain">     11   *  *  *</span></div><div class="token-line"><span class="token plain">     12   *  *  *</span></div><div class="token-line"><span class="token plain">     13   180.101.49.12  24.780ms  9.443ms  10.201ms</span></div></pre></div><p>这次就能顺利完成了，这是因为目的IP对ICMP是有回复的，所以traceroute就在最后一跳，也就是第13跳顺利停止了。</p><p>这里还有个小技巧。你有没有发现 <strong>UDP和ICMP这两种模式下，路径信息是可以互补的</strong>？比如UDP模式下没有显示第5和第7跳的IP，但是ICMP模式下就有。这就是为什么我建议你把两种模式分别跑一下，这样可以获取到尽可能完整的路径。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage864086ae98fb8478cb41eb9fc93a49561d40.018ecf96.jpg" alt="图片"/></p><p>第二个问题是关于telnet挂起。这里说的“挂起”，是指没有进一步的反应了，比如像下图这样：</p><p><img src="data:image/jpeg;base64,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" alt="图片"/></p><p>究其原因，就是telnet发送了SYN后没有收到SYN+ACK。我们在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/493040">第21讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提到了系统调用，那么对于telnet这样的用户空间程序来说，它要发起TCP连接，就必须调用 <strong>connect()</strong> 这个系统调用，后者会负责发出SYN。但是SYN发出去后，对端没有回复SYN+ACK，这就导致connect()阻塞，telnet程序也只好等在那里，表象上就是挂起了。</p><p>你可以参考这个示意图来理解整个过程：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage2ece2ee1c167f34cdecec04d2e7116a8b2ce.79389a84.jpg" alt=""/></p><p>当然，在第21讲我们也学习过strace这个工具了，所以我们可以用strace来验证这个过程。直接运行下面的命令：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">strace telnet www.baidu.com 500</span></div></pre></div><p>就能看到，strace停留在connect()系统调用这里了：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">......</span></div><div class="token-line"><span class="token plain">    socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span></div><div class="token-line"><span class="token plain">    setsockopt(3, SOL_IP, IP_TOS, [16], 4)  = 0</span></div><div class="token-line"><span class="token plain">    connect(3, {sa_family=AF_INET, sin_port=htons(500), sin_addr=inet_addr(&quot;45.113.192.102&quot;)}, 16</span></div></pre></div><h2 id="02讲的答疑"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#02讲的答疑"><span class="icon icon-link"></span></a>02讲的答疑</h2><h3 id="思考题-1"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-1"><span class="icon icon-link"></span></a>思考题</h3><ol><li>请你用偏移量方法，写一个tcpdump抓取TCP SYN包的过滤表达式。</li><li>如果确定问题是在IP层，tcpdump命令如何写，可以做到既找到IP层的问题，又节约抓包文件大小呢？</li></ol><h3 id="答案-1"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-1"><span class="icon icon-link"></span></a>答案</h3><p>很多同学都写出了正确的偏移量的过滤表达式，也就是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcpdump &#x27;tcp[13]&amp;2 != 0&#x27;</span></div></pre></div><p>当然，这个题目没有指明是一定只要SYN包，我们用上面这条命令可以抓到SYN和SYN+ACK这两种报文。而如果要指定只抓取SYN包而不抓取SYN+ACK，可以用下面的表达式：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcpdump &#x27;tcp[13]|2 = 2&#x27;</span></div></pre></div><blockquote><p>注意：这里的运算符是“<code>|</code>”，也就是字符或运算符。</p></blockquote><p>第二个问题的关键点是tcpdump的 <strong>-s参数</strong>，我们通过它可以指定要抓取的每个报文的大小。不过那就有个问题了，这里的“报文”是指IP分组还是二层帧呢？</p><p>虽然tcpdump名称里是tcp，实际上它能抓取udp、ip、icmp等等各种报文，因为它抓取的就是第二层的帧。所以说，<strong>这里的“报文大小”，指的是二层帧的大小</strong>。我在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/478189">第2讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里也贴了一张图，展示了在某一次抓包里，一个报文的各层占用的字节数：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage0cb60c23b60f7dcb62843e331e9b2972c8b6.d21c1092.png" alt="图片"/></p><p>一般来说，IP头部就是20字节，加上帧头14字节，所以<strong>理论上我们只要抓取前34字节的报文，就可以获取到二层和三层的信息了</strong>。</p><p>不过且慢，有个同学报告了一个问题：</p><blockquote><p>老师，对于“问题2”我有个疑问。我最开始用的命令是“<code>tcpdump \-i any \-s 34</code>”，发现-s写成34，就抓不到网络层的目的地址字段，用Wireshark分析后发现，帧头（不知道还叫不叫这个，Wireshark显示为 <code>Linux cooked capture v1</code>）占了16个字节，写成36就能把信息抓全了，但是写成“<code>tcpdump \-i eth0 \-s 34</code>”就可以抓全。</p></blockquote><p>这个问题我之前也没留意到，于是去查证了一下。原来在tcpdump里，对于any这个接口，它在输出帧头的时候用了一种叫 <strong>Linux cooked capture v1</strong> 的格式，这个格式的长度是16个字节，而以太网帧是14字节。这就造成了2个字节的差异，也就是按原先的34字节去抓取就不够了，所以要扩大到36字节才可以抓到完整的IP头部。</p><p>我们看一个例子：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage49e149494a525f79d26abb3d23cefc075fe1.14b67e98.jpg" alt="图片"/></p><blockquote><p>补充：上面的traceroute udp模式的示例文件就是用-i any模式抓取的，所以它的二层帧头就是 <code>Linux cooked capture v1</code> 格式。</p></blockquote><p>另外，“IP头部20字节”这个描述，其实还有一个隐含的前提：<strong>IP头部没有做扩展</strong>（Options）。跟TCP类似，IP头部也可以扩展，但是一般用的比较少，在公网上IP Options的报文有可能被丢弃，所以很少被采用。我们在内网也曾经做过实验，启用了IP Options，结果发现虽然内网设备可以支持IP Options，但是延迟增加了很多，所以最后还是取消了它。</p><h2 id="03讲的答疑"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#03讲的答疑"><span class="icon icon-link"></span></a>03讲的答疑</h2><h3 id="思考题-2"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-2"><span class="icon icon-link"></span></a>思考题</h3><ol><li>在Linux中，还有一个内核参数也是关于握手的，net.ipv4.tcp_synack_retries。你知道这个参数是用来做什么的吗？</li><li>如果握手双方，一方支持Window Scale，一方不支持，那么在这个连接里，Window Scale最终会被启用吗？你可以参考<a target="_blank" rel="noopener noreferrer" href="https://datatracker.ietf.org/doc/html/rfc1323">RFC1323<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，给出你的解答。</li></ol><h3 id="答案-2"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-2"><span class="icon icon-link"></span></a>答案</h3><p>第一个问题是关于Linux内核参数的。对于各种网络相关的内核参数来说，最快捷的方法可能就是直接在Linux主机里面查看TCP的手册了，也就是执行：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">man tcp</span></div></pre></div><p>然后搜索tcp_synack_retries就可以了，也就是这个部分：</p><blockquote><p>tcp_synack_retries (integer; default: 5; since Linux 2.2)<br/>The maximum number of times a SYN/ACK segment for a passive TCP connection will be retransmitted.  This number should not be higher than 255.</p></blockquote><p>也就说，<strong>这是TCP回复SYN+ACK后等不到ACK时，需要重试的次数</strong>。</p><p>第二个问题是关于Window Scale（下面简称WS）在握手中的具体实现。就像我题目里说的，你可以直接去找到<a target="_blank" rel="noopener noreferrer" href="https://datatracker.ietf.org/doc/html/rfc1323#page-8">RFC1323<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后找到这部分的内容：</p><blockquote><p>This option may be sent in an initial segment (i.e., a segment with the SYN bit on and the ACK bit off). It may also be sent in a &lt;SYN,ACK&gt; segment, but only if a Window Scale option was received in the initial segment. A Window Scale option in a segment without a SYN bit should be ignored.</p></blockquote><p>直译过来就是：这个WS选项可以在SYN包中，也可以在SYN+ACK包中。但只有收到的SYN中有这个WS选项，回复的SYN+ACK才可以加上这个选项。如果收到的报文不带SYN标志位但却带上了WS选项，这样的WS应该被忽略。</p><p>也就是说，如果发过来的SYN里不带WS选项，那回复的SYN+ACK也不应该带WS，自然这次的连接里也就不会用上WS了。简单来说，只要有一方不支持WS，这次的连接里就不会用WS。</p><h2 id="04讲的答疑"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#04讲的答疑"><span class="icon icon-link"></span></a>04讲的答疑</h2><h3 id="思考题-3"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-3"><span class="icon icon-link"></span></a>思考题</h3><ol><li>如果要在Wireshark中搜索到挥手阶段出现的RST+ACK报文，那么这个过滤器该如何写呢？</li><li>你有没有通过抓包分析，解决过应用层的奇怪问题呢？你是怎么做的呢？</li></ol><h3 id="答案-3"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-3"><span class="icon icon-link"></span></a>答案</h3><p>第一个问题里挥手阶段出现RST的现象， 这个已经不是用FIN完成的标准挥手过程了，而是出现了异常。不过从报文特征来说还是比较直接的，就是既要带RST标志位，也要带ACK标志位，所以答案就是：<strong>tcp.flags.ack==1 and tcp.flags.reset == 1</strong>。</p><p>第二个问题是开放式的，比如**@江山如画**同学分享了一个挺有意思的案例，是双方时钟不同步导致了TLS握手失败。时钟问题也是一个挺有“存在感”的问题，时不时会在各种故障中扮演一点角色，我们可以在排查没什么方向的时候，也可以查一下时钟。</p><p>另外说到TLS握手的问题，我在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/491674">第19讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里介绍了两个典型案例，也是刚过去不久的一讲，我想你应该还有印象。</p><h2 id="05讲的答疑"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#05讲的答疑"><span class="icon icon-link"></span></a>05讲的答疑</h2><h3 id="思考题-4"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#思考题-4"><span class="icon icon-link"></span></a>思考题</h3><p>这节课里，我介绍了使用裸序列号作为定位两侧同个报文的手段。那么要定位两侧的同个报文，除了这个方法，还有哪些方法呢？你可以从网络七层模型出发，给出自己的思考。</p><h3 id="答案-4"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#答案-4"><span class="icon icon-link"></span></a>答案</h3><p>定位两侧同个报文，是一个比较关键的技术点，因为抓包分析的一个重要任务，就是对比两侧抓包文件中的报文，从而判定丢包、乱序、重传等行为的严重程度和原因，由此才能针对性地做进一步排查乃至找到解决方案。如果不能找到“同个报文”，那刚才说的一系列工作就无从谈起了。</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimaged7e8d75d0d7acd0654648d39f00d8b027ee8.cea4a186.jpg" alt=""/></p><blockquote><p>补充：A和B对报文的编号一般是不同的，因为各自抓取报文的起始时间、抓取条件等都可能不同，就会导致抓取到的报文互有交集。</p></blockquote><p>比如上面就是一个典型的TCP问题的场景，也就是报文顺序发生了变化，这个现象就是“乱序”：发出1、2、3，收到的却是2、1、3。那么显然，我们需要在两侧的抓包文件里，找到对应的同个报文。事实上，现在说的1、2、3，是A的抓包文件里的报文编号，而B那边有自己的视角和报文编号，跟A是完全不同的。</p><p>我在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/481042">第5讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里介绍的方法，是用了裸序列号（原始序列号），因为TCP报文的这个序列号在传输中是不会变化的，所以这就是一个很好的确定报文的方法。其实，这属于<strong>第一大类方法：按照TCP报文的元信息，也就是TCP头部的特征去找到对应的报文</strong>。</p><p>既然确定了这个大类的方法原则，你很容易举一反三，想到其他的方法。比如：</p><ul><li>用TCP确认号，比如下面这个过滤器：</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.ack_raw == 754313633</span></div></pre></div><ul><li>如果有TCP timestamp扩展，就用TCP timestamp，比如下面两种过滤器：</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.options.timestamp.tsval == 2947948748</span></div><div class="token-line"><span class="token plain">    tcp.options.timestamp.tsecr == 3209788920</span></div></pre></div><ul><li>如果有TCP SACK扩展，就用SACK号，比如用过滤器：</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp.options.sack_le == 1234</span></div></pre></div><p>而<strong>第二个大类的方法，是利用TCP的载荷本身的特征去找到对应的报文</strong>。比如HTTP是文本协议，那么我们用下面这个过滤器，就可以找到含有这个字符串的报文：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">tcp contains &quot;id=abcdafeafeagfeagfaraera1242dfea&quot;</span></div></pre></div><p>其实换成以下这几种方式，也是一样的效果：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">frame contains &quot;id=abcdafeafeagfeagfaraera1242dfea&quot;</span></div><div class="token-line"><span class="token plain">    ip contains &quot;id=abcdafeafeagfeagfaraera1242dfea&quot;</span></div><div class="token-line"><span class="token plain">    http contains &quot;id=abcdafeafeagfeagfaraera1242dfea&quot;</span></div></pre></div><p>这个示意图，也表示了这样的两大类寻找对应报文的方法：</p><p><img src="/blog-base/static/httpsstatic001geekbangorgresourceimage5025502a6786f47a81306b62c60f883f8525.0ebf71fc.jpg" alt=""/></p><p>不过，你看了这张图，会不会以为我们每个报文都要这么找对应关系呢？那当然不用了，每个TCP流只要找一个关键报文，然后根据这个报文去做Follow -&gt; TCP Stream就好了。</p><h2 id="小结"><a aria-hidden="true" tabindex="-1" href="/blog-base/网络排查案例课/03.实战一tcp真实案例揭秘篇/04#小结"><span class="icon icon-link"></span></a>小结</h2><p>以上就是针对课程前5讲思考题的参考答案和拓展解读，希望能给你一些启发。另外，也非常感谢你对课后思考题的仔细思考和认真解答。在看留言的过程中，我从大家的答复中也看到了更加全面或是更加深入的思考，我自己受益匪浅。</p><p>接下来，我还会针对剩余的课后思考题，以及你的提问来作出解答。有任何问题，还是跟以前一样，欢迎你在留言区跟我交流，我们一同成长。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/网络排查案例课/03.实战一TCP真实案例揭秘篇/04.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/23 19:21:42</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-base/umi.js"></script>
  </body>
</html>
